

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pynit.core.handlers &mdash; PyNIT dev01 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="PyNIT dev01 documentation" href="../../../index.html"/>
        <link rel="up" title="pynit" href="../../pynit.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> PyNIT
          

          
          </a>

          
            
            
              <div class="version">
                0.1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <!-- Local TOC -->
                <div class="local-toc"></div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">PyNIT</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      
          <li><a href="../../pynit.html">pynit</a> &raquo;</li>
      
    <li>pynit.core.handlers</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pynit.core.handlers</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="k">import</span> <span class="n">mkdtemp</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="k">import</span> <span class="n">rmtree</span>

<span class="k">try</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;ipykernel&#39;</span><span class="p">]):</span>
        <span class="kn">from</span> <span class="nn">tqdm</span> <span class="k">import</span> <span class="n">tqdm_notebook</span> <span class="k">as</span> <span class="n">progressbar</span>
        <span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="k">import</span> <span class="n">widgets</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">tqdm</span> <span class="k">import</span> <span class="n">tqdm</span> <span class="k">as</span> <span class="n">progressbar</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">namedtuple</span>

<span class="kn">from</span> <span class="nn">.objects</span> <span class="k">import</span> <span class="n">Reference</span><span class="p">,</span> <span class="n">ImageObj</span>
<span class="kn">from</span> <span class="nn">.processors</span> <span class="k">import</span> <span class="n">Analysis</span><span class="p">,</span> <span class="n">Interface</span><span class="p">,</span> <span class="n">TempFile</span>
<span class="kn">from</span> <span class="nn">.methods</span> <span class="k">import</span> <span class="n">np</span>
<span class="kn">from</span> <span class="nn">.visualizers</span> <span class="k">import</span> <span class="n">Viewer</span>
<span class="kn">import</span> <span class="nn">messages</span>
<span class="kn">import</span> <span class="nn">methods</span>

<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">from</span> <span class="nn">multiprocessing.pool</span> <span class="k">import</span> <span class="n">ThreadPool</span>


<div class="viewcode-block" id="Project"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Project">[docs]</a><span class="k">class</span> <span class="nc">Project</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Project Handler for fMRI datasets</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_path</span><span class="p">,</span> <span class="n">ds_ref</span><span class="o">=</span><span class="s1">&#39;NIRAL&#39;</span><span class="p">,</span> <span class="n">img_format</span><span class="o">=</span><span class="s1">&#39;NifTi-1&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load and initiate the project</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        project_path:   str</span>
<span class="sd">            Path of particular project</span>
<span class="sd">        ds_ref:         str</span>
<span class="sd">            Reference of data structure (default: &#39;NIRAL&#39;)</span>
<span class="sd">        img_format:     str</span>
<span class="sd">            Reference img format</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Display options for pandasDataframe</span>
        <span class="n">max_rows</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="n">max_colwidth</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;max_rows&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">max_rows</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;max_rows&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;max_colwidth&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">max_colwidth</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;max_colwidth&#39;</span><span class="p">]</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">max_rows</span> <span class="o">=</span> <span class="n">max_rows</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">max_colwidth</span> <span class="o">=</span> <span class="n">max_colwidth</span>

        <span class="c1"># Define default attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">single_session</span> <span class="o">=</span> <span class="kc">False</span>             <span class="c1"># True if project has single session</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__empty_project</span> <span class="o">=</span> <span class="kc">False</span>            <span class="c1"># True if project folder is empty</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">6</span>
        <span class="c1"># Each values are represented subject, session, dtype(or pipeline), step(or results) file_tags, ignores</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__path</span> <span class="o">=</span> <span class="n">project_path</span>

        <span class="c1"># Set internal objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__df</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="c1"># Parsing the information from the reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__ref</span> <span class="o">=</span> <span class="p">[</span><span class="n">ds_ref</span><span class="p">,</span> <span class="n">img_format</span><span class="p">]</span>       <span class="c1">#TODO: Check the develope note for future usage of this part</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref</span> <span class="o">=</span> <span class="n">Reference</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">__ref</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">img_ext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">imgext</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">ref_ds</span>

        <span class="c1"># Define default filter values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__dc_idx</span> <span class="o">=</span> <span class="mi">0</span>                       <span class="c1"># Dataclass index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__ext_filter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_ext</span>        <span class="c1"># File extension</span>

        <span class="c1"># Generate folders for dataclasses</span>
        <span class="n">methods</span><span class="o">.</span><span class="n">mk_main_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Scan project folder</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scan_prj</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">raiseerror</span><span class="p">(</span><span class="n">messages</span><span class="o">.</span><span class="n">Errors</span><span class="o">.</span><span class="n">ProjectScanFailure</span><span class="p">,</span> <span class="s1">&#39;Error is occurred during a scanning.&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">df</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Dataframe for handling data structure</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dataset : pandas.Dataframe</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__df</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[</span><span class="n">columns</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Project path</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        path    : str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__path</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dataclass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Dataclass index</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        index   : int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_type</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__dc_idx</span><span class="p">]</span>

    <span class="nd">@dataclass</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">dataclass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__dc_idx</span> <span class="o">=</span> <span class="n">idx</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">raiseerror</span><span class="p">(</span><span class="n">messages</span><span class="o">.</span><span class="n">Errors</span><span class="o">.</span><span class="n">InputDataclassError</span><span class="p">,</span> <span class="s1">&#39;Wrong dataclass index.&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">subjects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__subjects</span>

    <span class="c1"># @subjects.setter</span>
    <span class="c1"># def subjects(self, idx):</span>
    <span class="c1">#     self.__subjects = sorted(list(set(self.df.Subject.tolist())))</span>
    <span class="c1">#     try:</span>
    <span class="c1">#         if isinstance(idx, list):</span>
    <span class="c1">#             if len(idx) == 2:</span>
    <span class="c1">#                 self.__subjects = self.__subjects[idx[0]:idx[1]]</span>
    <span class="c1">#             else:</span>
    <span class="c1">#                 methods.raiseerror(messages.Errors.InputValueError, &#39;Wrong indexing.&#39;)</span>
    <span class="c1">#         elif isinstance(idx, int):</span>
    <span class="c1">#             self.__subjects = [self.__subjects[idx]]</span>
    <span class="c1">#         else:</span>
    <span class="c1">#             methods.raiseerror(messages.Errors.InputValueError, &#39;Wrong indexing.&#39;)</span>
    <span class="c1">#     except:</span>
    <span class="c1">#         methods.raiseerror(messages.Errors.InputValueError, &#39;Wrong indexing.&#39;)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sessions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sessions</span>

    <span class="c1"># @sessions.setter</span>
    <span class="c1"># def sessions(self, idx):</span>
    <span class="c1">#     self.__sessions = sorted(list(set(self.df.Session.tolist())))</span>
    <span class="c1">#     try:</span>
    <span class="c1">#         if isinstance(idx, list):</span>
    <span class="c1">#             if len(idx) == 2:</span>
    <span class="c1">#                 self.__sessions = self.__sessions[idx[0]:idx[1]]</span>
    <span class="c1">#             else:</span>
    <span class="c1">#                 methods.raiseerror(messages.Errors.InputValueError, &#39;Wrong indexing.&#39;)</span>
    <span class="c1">#         elif isinstance(idx, int):</span>
    <span class="c1">#             self.__sessions = [self.__sessions[idx]]</span>
    <span class="c1">#         else:</span>
    <span class="c1">#             methods.raiseerror(messages.Errors.InputValueError, &#39;Wrong indexing.&#39;)</span>
    <span class="c1">#     except:</span>
    <span class="c1">#         methods.raiseerror(messages.Errors.InputValueError, &#39;Wrong indexing.&#39;)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dtypes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dtypes</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pipelines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pipelines</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">steps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__steps</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__results</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__summary</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ext_filter</span>

    <span class="nd">@ext</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">ext</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__ext_filter</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__ext_filter</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__ext_filter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">raiseerror</span><span class="p">(</span><span class="n">messages</span><span class="o">.</span><span class="n">Errors</span><span class="o">.</span><span class="n">InputTypeError</span><span class="p">,</span>
                               <span class="s1">&#39;Please use correct input type.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ref_exts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        type    : str</span>
<span class="sd">            type of ext [&#39;all&#39;, &#39;img&#39;, &#39;txt&#39;]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        return value</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">img_ext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">img</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="n">txt_ext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">txt</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="n">all_ext</span> <span class="o">=</span> <span class="n">img_ext</span><span class="o">+</span><span class="n">txt_ext</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;img&#39;</span><span class="p">,</span> <span class="s1">&#39;txt&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">all_ext</span>
            <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;img&#39;</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">img_ext</span>
            <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;txt&#39;</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">txt_ext</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">output</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">raiseerror</span><span class="p">(</span><span class="n">messages</span><span class="o">.</span><span class="n">Errors</span><span class="o">.</span><span class="n">InputTypeError</span><span class="p">,</span>
                               <span class="s2">&quot;only one of the value in [&#39;all&#39;.&#39;img&#39;.&#39;txt&#39;] is available for type.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Project.reload"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Project.reload">[docs]</a>    <span class="k">def</span> <span class="nf">reload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span></div>

<div class="viewcode-block" id="Project.reset"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Project.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rescan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Reset DataFrame</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rescan  : Boolean</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">rescan</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__dc_idx</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scan_prj</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__empty_project</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dataclass &#39;</span><span class="si">{}</span><span class="s2">&#39; is Empty&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds_type</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__dc_idx</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__dc_idx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scan_prj</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prj_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_type</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__dc_idx</span><span class="p">],</span> <span class="s1">&#39;.class_dataframe&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">prj_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__df</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scan_prj</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__df</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__empty_project</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Project.save_df"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Project.save_df">[docs]</a>    <span class="k">def</span> <span class="nf">save_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dc_idx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Save Dataframe to pickle file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dc_idx  : index in range(3)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dc_df</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_type</span><span class="p">[</span><span class="n">dc_idx</span><span class="p">],</span> <span class="s1">&#39;.class_dataframe&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dc_df</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__df</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.reset_filters"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Project.reset_filters">[docs]</a>    <span class="k">def</span> <span class="nf">reset_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Reset filter - Clear all filter information and extension</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ext     : str</span>
<span class="sd">            Filter parameter for file extension</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">6</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ext</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_ext</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ext</span> <span class="o">=</span> <span class="n">ext</span></div>

<div class="viewcode-block" id="Project.scan_prj"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Project.scan_prj">[docs]</a>    <span class="k">def</span> <span class="nf">scan_prj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Reload the Dataframe based on current set data class and extension</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Parsing command works</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_session</span><span class="p">,</span> <span class="n">empty_prj</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">parsing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dc_idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">empty_prj</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__df</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">initial_filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_exts</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__df</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__df</span><span class="p">[</span><span class="n">methods</span><span class="o">.</span><span class="n">reorder_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__dc_idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_session</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__empty_project</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__update</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__empty_project</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_df</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__dc_idx</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.set_filters"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Project.set_filters">[docs]</a>    <span class="k">def</span> <span class="nf">set_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set filters</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        args    : str[, ]</span>
<span class="sd">            String arguments regarding hierarchical data structures</span>
<span class="sd">        kwargs  : key=value pair[, ]</span>
<span class="sd">            Key and value pairs for the filtering parameter on filename</span>

<span class="sd">            (key) file_tag  : str or list of str</span>
<span class="sd">                Keywords of interest for filename</span>
<span class="sd">            (key) ignore    : str or list of str</span>
<span class="sd">                Keywords of neglect for filename</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_filters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ext</span><span class="p">)</span>
        <span class="n">pipe_filter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;dataclass&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dataclass</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;dataclass&#39;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;ext&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ext</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ext&#39;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;file_tag&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;file_tag&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;file_tag&#39;</span><span class="p">]]</span>
                    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;file_tag&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;file_tag&#39;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">methods</span><span class="o">.</span><span class="n">raiseerror</span><span class="p">(</span><span class="n">messages</span><span class="o">.</span><span class="n">Errors</span><span class="o">.</span><span class="n">InputTypeError</span><span class="p">,</span>
                                                 <span class="s1">&#39;Please use correct input type for FileTag&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;ignore&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ignore&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ignore&#39;</span><span class="p">]]</span>
                    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ignore&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ignore&#39;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">methods</span><span class="o">.</span><span class="n">raiseerror</span><span class="p">(</span><span class="n">messages</span><span class="o">.</span><span class="n">Errors</span><span class="o">.</span><span class="n">InputTypeError</span><span class="p">,</span>
                                                 <span class="s1">&#39;Please use correct input type for FileTag to ignore&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">methods</span><span class="o">.</span><span class="n">raiseerror</span><span class="p">(</span><span class="n">messages</span><span class="o">.</span><span class="n">Errors</span><span class="o">.</span><span class="n">KeywordError</span><span class="p">,</span>
                                             <span class="s2">&quot;&#39;</span><span class="si">{key}</span><span class="s2">&#39; is not correct kwarg&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">residuals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">:</span>
                <span class="n">subj_filter</span><span class="p">,</span> <span class="n">residuals</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_arguments</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">residuals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">subj_filter</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">subj_filter</span><span class="p">[:]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_session</span><span class="p">:</span>
                    <span class="n">sess_filter</span><span class="p">,</span> <span class="n">residuals</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_arguments</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">residuals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">sess_filter</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sess_filter</span><span class="p">[:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dc_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtypes</span><span class="p">:</span>
                    <span class="n">dtyp_filter</span><span class="p">,</span> <span class="n">residuals</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_arguments</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">residuals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtypes</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">dtyp_filter</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dtyp_filter</span><span class="p">[:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dc_idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelines</span><span class="p">:</span>
                    <span class="n">pipe_filter</span><span class="p">,</span> <span class="n">residuals</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_arguments</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">residuals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelines</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">pipe_filter</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pipe_filter</span><span class="p">[:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">:</span>
                    <span class="n">step_filter</span><span class="p">,</span> <span class="n">residuals</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_arguments</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">residuals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">step_filter</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_filter</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelines</span><span class="p">:</span>
                    <span class="n">pipe_filter</span><span class="p">,</span> <span class="n">residuals</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_arguments</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">residuals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelines</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">pipe_filter</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pipe_filter</span><span class="p">[:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
                    <span class="n">rslt_filter</span><span class="p">,</span> <span class="n">residuals</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_arguments</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">residuals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">rslt_filter</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">rslt_filter</span><span class="p">[:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">residuals</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclass</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_type</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pipe_filter</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">dc_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">pipe_filter</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">processed</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dc_path</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">step</span> <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">processed</span> <span class="k">if</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">residuals</span><span class="p">]):</span>
                            <span class="n">methods</span><span class="o">.</span><span class="n">raiseerror</span><span class="p">(</span><span class="n">messages</span><span class="o">.</span><span class="n">Errors</span><span class="o">.</span><span class="n">NoFilteredOutput</span><span class="p">,</span>
                                               <span class="s1">&#39;Cannot find any results from [</span><span class="si">{residuals}</span><span class="s1">]</span><span class="se">\n</span><span class="s1">&#39;</span>
                                               <span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">Please take a look if you had applied correct input&#39;</span>
                                               <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">residuals</span><span class="o">=</span><span class="n">residuals</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">methods</span><span class="o">.</span><span class="n">raiseerror</span><span class="p">(</span><span class="n">messages</span><span class="o">.</span><span class="n">Errors</span><span class="o">.</span><span class="n">NoFilteredOutput</span><span class="p">,</span>
                                           <span class="s1">&#39;Uncertain exception occured, please report to Author (shlee@unc.edu)&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">methods</span><span class="o">.</span><span class="n">raiseerror</span><span class="p">(</span><span class="n">messages</span><span class="o">.</span><span class="n">Errors</span><span class="o">.</span><span class="n">NoFilteredOutput</span><span class="p">,</span>
                                       <span class="s1">&#39;Wrong filter input:</span><span class="si">{residuals}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">residuals</span><span class="o">=</span><span class="n">residuals</span><span class="p">))</span></div>

<div class="viewcode-block" id="Project.apply"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Project.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Applying all filters to current dataframe</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">applying_filters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__df</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__update</span><span class="p">()</span></div>

<div class="viewcode-block" id="Project.applying_filters"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Project.applying_filters">[docs]</a>    <span class="k">def</span> <span class="nf">applying_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Applying current filters to the given dataframe</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df      : pandas.DataFrame</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        df      : pandas.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">Subject</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dc_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">DataType</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">Pipeline</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dc_idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">Step</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">3</span><span class="p">])]</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dc_idx</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">Result</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">3</span><span class="p">])]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">file_tag</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">Filename</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_tag</span><span class="p">))]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ignore</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">Filename</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ignore</span><span class="p">))]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ext</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Filename&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">r</span><span class="s2">&quot;</span><span class="si">{ext}</span><span class="s2">$&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ext</span><span class="o">=</span><span class="n">ext</span><span class="p">)</span> <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ext</span><span class="p">]))]</span>
            <span class="k">return</span> <span class="n">df</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="Project.run"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Project.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute processing tools</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">command</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">Interface</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="n">Interface</span><span class="p">,</span> <span class="n">command</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">exec</span><span class="p">(</span><span class="s1">&#39;help(Interface.</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">Interface</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">messages</span><span class="o">.</span><span class="n">CommandExecutionFailure</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">messages</span><span class="o">.</span><span class="n">NotExistingCommand</span></div>

    <span class="k">def</span> <span class="nf">__summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print summary of current project</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="s1">&#39;** Project summary&#39;</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1">Project: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__empty_project</span><span class="p">:</span>
            <span class="n">summary</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1">[Empty project]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">summary</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1">Selected DataClass: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclass</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelines</span><span class="p">:</span>
                <span class="n">summary</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1">Applied Pipeline(s): </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipelines</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">:</span>
                <span class="n">summary</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1">Applied Step(s): </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
                <span class="n">summary</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1">Processed Result(s): </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">:</span>
                <span class="n">summary</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1">Subject(s): </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
                <span class="n">summary</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1">Session(s): </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtypes</span><span class="p">:</span>
                <span class="n">summary</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1">DataType(s): </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtypes</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_session</span><span class="p">:</span>
                <span class="n">summary</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1">Single session dataset&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
            <span class="n">summary</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n\n</span><span class="s1">Applied filters&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">summary</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1">Set subject(s): </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">summary</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1">Set session(s): </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dc_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                    <span class="n">summary</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1">Set datatype(s): </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                    <span class="n">summary</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1">Set Pipeline(s): </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dc_idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">summary</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1">Set Step(s): </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">summary</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1">Set Result(s): </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ext_filter</span><span class="p">:</span>
                <span class="n">summary</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1">Set file extension(s): </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ext_filter</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span>
                <span class="n">summary</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1">Set file tag(s): </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span>
                <span class="n">summary</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1">Set ignore(s): </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update attributes of Project object based on current set filter information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__subjects</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Subject</span><span class="o">.</span><span class="n">tolist</span><span class="p">())))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_session</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__sessions</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__sessions</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">tolist</span><span class="p">())))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dc_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__dtypes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">DataType</span><span class="o">.</span><span class="n">tolist</span><span class="p">())))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__pipelines</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__steps</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__results</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dc_idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__dtypes</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__pipelines</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Pipeline</span><span class="o">.</span><span class="n">tolist</span><span class="p">())))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__steps</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Step</span><span class="o">.</span><span class="n">tolist</span><span class="p">())))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__results</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dc_idx</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__dtypes</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__pipelines</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Pipeline</span><span class="o">.</span><span class="n">tolist</span><span class="p">())))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__results</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Result</span><span class="o">.</span><span class="n">tolist</span><span class="p">())))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__steps</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">methods</span><span class="o">.</span><span class="n">raiseerror</span><span class="p">(</span><span class="n">messages</span><span class="o">.</span><span class="n">Errors</span><span class="o">.</span><span class="n">UpdateAttributesFailed</span><span class="p">,</span>
                                   <span class="s2">&quot;Error occured during update project&#39;s attributes&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__subjects</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__sessions</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__dtypes</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__pipelines</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__steps</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__results</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dc_id</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return DataFrame followed applying filters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataclass</span> <span class="o">=</span> <span class="n">dc_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="n">prj</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">prj</span><span class="o">.</span><span class="n">set_filters</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">prj</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">prj</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return absolute path for current filtered dataframe</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__empty_project</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Abspath</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return particular data based on input index</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__empty_project</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterator for dataframe</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__empty_project</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">messages</span><span class="o">.</span><span class="n">EmptyProject</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="k">yield</span> <span class="n">row</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return number of data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__empty_project</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span></div>


<div class="viewcode-block" id="Process"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Process">[docs]</a><span class="k">class</span> <span class="nc">Process</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Collections of step components for pipelines</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prjobj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logging</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prjobj</span>
<span class="sd">        name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prjobj</span><span class="o">.</span><span class="n">reset_filters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span> <span class="o">=</span> <span class="n">prjobj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">ds_type</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">logging</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subjects</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sessions</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_history</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parallel</span> <span class="o">=</span> <span class="n">parallel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tempfiles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_proc</span><span class="p">()</span>

<div class="viewcode-block" id="Process.check_input"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Process.check_input">[docs]</a>    <span class="k">def</span> <span class="nf">check_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check input_path and return absolute path</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        input_path : str</span>
<span class="sd">            Step path</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        input_path : str</span>
<span class="sd">            Absolute path of step</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">input_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">executed</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_history</span><span class="p">[</span><span class="n">input_path</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">input_path</span></div>

<div class="viewcode-block" id="Process.afni_MeanImgCalc"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Process.afni_MeanImgCalc">[docs]</a>    <span class="k">def</span> <span class="nf">afni_MeanImgCalc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">cbv</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">surfix</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Mean image calculation for functional image</span>

<span class="sd">        Major purpose of this preprocessing step is to prepare base-images</span>
<span class="sd">        for both mask drawing and motion correction.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func : str</span>
<span class="sd">            datatype of absolute_path</span>
<span class="sd">        cbv : boolean</span>
<span class="sd">            True if MION contrast agent is infused</span>
<span class="sd">        surfix : str</span>
<span class="sd">            Output folder surfix</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        output_path : dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_input</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">Step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_input</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="n">input_path</span><span class="o">=</span><span class="n">func</span><span class="p">,</span> <span class="n">static</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_outparam</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;mparam&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;.1D&#39;</span><span class="p">)</span>
        <span class="n">cmd01</span> <span class="o">=</span> <span class="s2">&quot;3dvolreg -prefix </span><span class="si">{temp_01}</span><span class="s2"> -1Dfile </span><span class="si">{mparam}</span><span class="s2"> -Fourier -verbose -base 0 </span><span class="si">{func}</span><span class="s2">&quot;</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_command</span><span class="p">(</span><span class="n">cmd01</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cbv</span><span class="p">:</span>
            <span class="n">cmd02</span> <span class="o">=</span> <span class="s2">&quot;3dinfo -nv </span><span class="si">{func}</span><span class="s2">&quot;</span>
            <span class="n">step</span><span class="o">.</span><span class="n">set_staticinput</span><span class="p">(</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="s1">&#39;int(int(ttime)/3)&#39;</span><span class="p">)</span>
            <span class="n">step</span><span class="o">.</span><span class="n">set_staticinput</span><span class="p">(</span><span class="s1">&#39;bold_output&#39;</span><span class="p">,</span> <span class="s1">&#39;methods.splitnifti(output)+&quot;_BOLD.nii.gz&quot;&#39;</span><span class="p">)</span>
            <span class="n">step</span><span class="o">.</span><span class="n">set_staticinput</span><span class="p">(</span><span class="s1">&#39;cbv&#39;</span><span class="p">,</span> <span class="s1">&#39;int(int(ttime)*2/3)&#39;</span><span class="p">)</span>
            <span class="n">step</span><span class="o">.</span><span class="n">set_staticinput</span><span class="p">(</span><span class="s1">&#39;cbv_output&#39;</span><span class="p">,</span> <span class="s1">&#39;methods.splitnifti(output)+&quot;_CBV.nii.gz&quot;&#39;</span><span class="p">)</span>
            <span class="n">step</span><span class="o">.</span><span class="n">set_command</span><span class="p">(</span><span class="n">cmd02</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="s1">&#39;ttime&#39;</span><span class="p">)</span>
            <span class="n">options</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&quot;[0..</span><span class="si">{bold}</span><span class="s1">]&quot;&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;&quot;[</span><span class="si">{cbv}</span><span class="s1">..$]&quot;&#39;</span><span class="p">]</span>
            <span class="n">cmd03</span> <span class="o">=</span> <span class="s2">&quot;3dTstat -prefix </span><span class="si">{bold_output}</span><span class="s2"> -mean </span><span class="si">{temp_01}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">step</span><span class="o">.</span><span class="n">set_command</span><span class="p">(</span><span class="n">cmd03</span><span class="p">)</span>
            <span class="n">cmd04</span> <span class="o">=</span> <span class="s2">&quot;3dTstat -prefix </span><span class="si">{cbv_output}</span><span class="s2"> -mean </span><span class="si">{temp_01}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">options</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">step</span><span class="o">.</span><span class="n">set_command</span><span class="p">(</span><span class="n">cmd04</span><span class="p">)</span>
            <span class="c1"># step.get_executefunc(&#39;test&#39;, verbose=True)</span>
            <span class="n">output_path</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;MeanImgCalc-CBV&#39;</span><span class="p">,</span> <span class="n">surfix</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd02</span> <span class="o">=</span> <span class="s2">&quot;3dTstat -prefix </span><span class="si">{output}</span><span class="s2"> -mean </span><span class="si">{temp_01}</span><span class="s2">&quot;</span>
            <span class="n">step</span><span class="o">.</span><span class="n">set_command</span><span class="p">(</span><span class="n">cmd02</span><span class="p">)</span>
            <span class="c1"># step.get_executefunc(&#39;test&#39;, verbose=True)</span>
            <span class="n">output_path</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;MeanImgCalc-BOLD&#39;</span><span class="p">,</span> <span class="n">surfix</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">meanfunc</span><span class="o">=</span><span class="n">output_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="Process.afni_SliceTimingCorrection"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Process.afni_SliceTimingCorrection">[docs]</a>    <span class="k">def</span> <span class="nf">afni_SliceTimingCorrection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">tr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tpattern</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">surfix</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Corrects for slice time differences when individual 2D slices are recorded over a 3D image</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func : str</span>
<span class="sd">        tr : int</span>
<span class="sd">        tpattern : str</span>
<span class="sd">        surfix : str</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        output_path : dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_input</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="n">options</span> <span class="o">=</span> <span class="nb">str</span><span class="p">()</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">Step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_input</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="n">input_path</span><span class="o">=</span><span class="n">func</span><span class="p">,</span> <span class="n">static</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;3dTshift -prefix </span><span class="si">{output}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">tr</span><span class="p">:</span>
            <span class="n">options</span> <span class="o">+=</span> <span class="s2">&quot; -tr </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tpattern</span><span class="p">:</span>
            <span class="n">options</span> <span class="o">+=</span> <span class="s2">&quot; -tpattern </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tpattern</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">options</span> <span class="o">+=</span> <span class="s2">&quot; -tpattern altplus&quot;</span>
        <span class="n">input_str</span> <span class="o">=</span> <span class="s2">&quot; </span><span class="si">{func}</span><span class="s2">&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">+</span><span class="n">options</span><span class="o">+</span><span class="n">input_str</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="c1"># step.get_executefunc(&#39;test&#39;, verbose=True)</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;SliceTmCorrect&#39;</span><span class="p">,</span> <span class="n">surfix</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">output_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="Process.afni_MotionCorrection"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Process.afni_MotionCorrection">[docs]</a>    <span class="k">def</span> <span class="nf">afni_MotionCorrection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">surfix</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_input</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">Step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">step</span><span class="o">.</span><span class="n">set_input</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="n">input_path</span><span class="o">=</span><span class="n">func</span><span class="p">,</span> <span class="n">static</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mimg_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;-CBV-&#39;</span> <span class="ow">in</span> <span class="n">mimg_path</span><span class="p">:</span>
                <span class="n">mimg_filters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;file_tag&#39;</span><span class="p">:</span> <span class="s1">&#39;_CBV&#39;</span><span class="p">}</span>
                <span class="n">step</span><span class="o">.</span><span class="n">set_input</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;base&#39;</span><span class="p">,</span> <span class="n">input_path</span><span class="o">=</span><span class="n">mimg_path</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="n">mimg_filters</span><span class="p">,</span> <span class="n">static</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">step</span><span class="o">.</span><span class="n">set_input</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;base&#39;</span><span class="p">,</span> <span class="n">input_path</span><span class="o">=</span><span class="n">mimg_path</span><span class="p">,</span> <span class="n">static</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">raiseerror</span><span class="p">(</span><span class="n">messages</span><span class="o">.</span><span class="n">Errors</span><span class="o">.</span><span class="n">MissingPipeline</span><span class="p">,</span>
                               <span class="s1">&#39;Initial Mean image calculation step has not been executed!&#39;</span><span class="p">)</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_outparam</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;mparam&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;.1D&#39;</span><span class="p">)</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_outparam</span><span class="p">(</span><span class="s1">&#39;transmat&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;.aff12.1D&#39;</span><span class="p">)</span>
        <span class="n">cmd01</span> <span class="o">=</span> <span class="s2">&quot;3dvolreg -prefix </span><span class="si">{temp_01}</span><span class="s2"> -1Dfile </span><span class="si">{mparam}</span><span class="s2"> -Fourier -verbose -base 0 </span><span class="si">{func}</span><span class="s2">&quot;</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_command</span><span class="p">(</span><span class="n">cmd01</span><span class="p">)</span>
        <span class="n">cmd02</span> <span class="o">=</span> <span class="s2">&quot;3dTstat -mean -prefix </span><span class="si">{temp_02}</span><span class="s2"> </span><span class="si">{temp_01}</span><span class="s2">&quot;</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_command</span><span class="p">(</span><span class="n">cmd02</span><span class="p">)</span>
        <span class="n">cmd03</span> <span class="o">=</span> <span class="s2">&quot;3dAllineate -prefix </span><span class="si">{temp_03}</span><span class="s2"> -warp sho -base </span><span class="si">{base}</span><span class="s2"> -1Dmatrix_save </span><span class="si">{transmat}</span><span class="s2"> </span><span class="si">{temp_02}</span><span class="s2">&quot;</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_command</span><span class="p">(</span><span class="n">cmd03</span><span class="p">)</span>
        <span class="n">cmd04</span> <span class="o">=</span> <span class="s1">&#39;3dAllineate -prefix </span><span class="si">{output}</span><span class="s1"> -1Dmatrix_apply </span><span class="si">{transmat}</span><span class="s1"> -warp sho </span><span class="si">{temp_01}</span><span class="s1">&#39;</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_command</span><span class="p">(</span><span class="n">cmd04</span><span class="p">)</span>
        <span class="c1"># step.get_executefunc(&#39;test&#39;, verbose=True)</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;MotionCorrection&#39;</span><span class="p">,</span> <span class="n">surfix</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">output_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="Process.afni_MaskPrep"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Process.afni_MaskPrep">[docs]</a>    <span class="k">def</span> <span class="nf">afni_MaskPrep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">anat</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        anat</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">anat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_input</span><span class="p">(</span><span class="n">anat</span><span class="p">)</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">Step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">step</span><span class="o">.</span><span class="n">set_input</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat&#39;</span><span class="p">,</span> <span class="n">input_path</span><span class="o">=</span><span class="n">anat</span><span class="p">,</span> <span class="n">static</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">raiseerror</span><span class="p">(</span><span class="n">messages</span><span class="o">.</span><span class="n">Errors</span><span class="o">.</span><span class="n">MissingPipeline</span><span class="p">,</span>
                               <span class="s1">&#39;No anatomy file!&#39;</span><span class="p">)</span>
        <span class="n">cmd01</span> <span class="o">=</span> <span class="s1">&#39;3dcalc -prefix </span><span class="si">{output}</span><span class="s1"> -expr &quot;a&quot; -a </span><span class="si">{anat}</span><span class="s1">&#39;</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_command</span><span class="p">(</span><span class="n">cmd01</span><span class="p">)</span>
        <span class="n">anat_path</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;MaskPrep&#39;</span><span class="p">,</span> <span class="s1">&#39;anat&#39;</span><span class="p">)</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">Step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mimg_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;-CBV-&#39;</span> <span class="ow">in</span> <span class="n">mimg_path</span><span class="p">:</span>
                <span class="n">mimg_filters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;file_tag&#39;</span><span class="p">:</span> <span class="s1">&#39;_BOLD&#39;</span><span class="p">}</span>
                <span class="n">step</span><span class="o">.</span><span class="n">set_input</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="n">input_path</span><span class="o">=</span><span class="n">mimg_path</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="n">mimg_filters</span><span class="p">,</span> <span class="n">static</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">step</span><span class="o">.</span><span class="n">set_input</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="n">input_path</span><span class="o">=</span><span class="n">mimg_path</span><span class="p">,</span> <span class="n">static</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">raiseerror</span><span class="p">(</span><span class="n">messages</span><span class="o">.</span><span class="n">Errors</span><span class="o">.</span><span class="n">MissingPipeline</span><span class="p">,</span>
                               <span class="s1">&#39;Initial Mean image calculation step has not been executed!&#39;</span><span class="p">)</span>
        <span class="n">cmd02</span> <span class="o">=</span> <span class="s1">&#39;3dcalc -prefix </span><span class="si">{output}</span><span class="s1"> -expr &quot;a&quot; -a </span><span class="si">{func}</span><span class="s1">&#39;</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_command</span><span class="p">(</span><span class="n">cmd02</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">func_path</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;MaskPrep&#39;</span><span class="p">,</span> <span class="s1">&#39;meanfunc&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">anat</span><span class="o">=</span><span class="n">anat_path</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">func_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="Process.afni_SkullStrip"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Process.afni_SkullStrip">[docs]</a>    <span class="k">def</span> <span class="nf">afni_SkullStrip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">anat</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func</span>
<span class="sd">        anat</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">anat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_input</span><span class="p">(</span><span class="n">anat</span><span class="p">)</span>
        <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_input</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">Step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">mask_filters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;file_tag&#39;</span><span class="p">:</span> <span class="s1">&#39;_mask&#39;</span><span class="p">}</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_input</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat&#39;</span><span class="p">,</span> <span class="n">input_path</span><span class="o">=</span><span class="n">anat</span><span class="p">,</span> <span class="n">static</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_input</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_mask&#39;</span><span class="p">,</span> <span class="n">input_path</span><span class="o">=</span><span class="n">anat</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="n">mask_filters</span><span class="p">,</span> <span class="n">static</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cmd01</span> <span class="o">=</span> <span class="s1">&#39;3dcalc -prefix </span><span class="si">{output}</span><span class="s1"> -expr &quot;a*step(b)&quot; -a </span><span class="si">{anat}</span><span class="s1"> -b </span><span class="si">{anat_mask}</span><span class="s1">&#39;</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_command</span><span class="p">(</span><span class="n">cmd01</span><span class="p">)</span>
        <span class="n">anat_path</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;SkullStrip&#39;</span><span class="p">,</span> <span class="s1">&#39;anat&#39;</span><span class="p">)</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">Step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_input</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="n">input_path</span><span class="o">=</span><span class="n">func</span><span class="p">,</span> <span class="n">static</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_input</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;func_mask&#39;</span><span class="p">,</span> <span class="n">input_path</span><span class="o">=</span><span class="n">func</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="n">mask_filters</span><span class="p">,</span> <span class="n">static</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cmd02</span> <span class="o">=</span> <span class="s1">&#39;3dcalc -prefic </span><span class="si">{output}</span><span class="s1"> -expr &quot;a*step(b)&quot; -a </span><span class="si">{func}</span><span class="s1"> -b </span><span class="si">{func_mask}</span><span class="s1">&#39;</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_command</span><span class="p">(</span><span class="n">cmd02</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">func_path</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;SkullStrip&#39;</span><span class="p">,</span> <span class="s1">&#39;meanfunc&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">anat</span><span class="o">=</span><span class="n">anat_path</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">func_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="Process.afni_Coreg"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Process.afni_Coreg">[docs]</a>    <span class="k">def</span> <span class="nf">afni_Coreg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">anat</span><span class="p">,</span> <span class="n">meanfunc</span><span class="p">,</span> <span class="n">surfix</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        meanfunc</span>
<span class="sd">        anat</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">anat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_input</span><span class="p">(</span><span class="n">anat</span><span class="p">)</span>
        <span class="n">meanfunc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_input</span><span class="p">(</span><span class="n">meanfunc</span><span class="p">)</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">Step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_input</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat&#39;</span><span class="p">,</span> <span class="n">input_path</span><span class="o">=</span><span class="n">anat</span><span class="p">,</span> <span class="n">static</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_input</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="n">input_path</span><span class="o">=</span><span class="n">meanfunc</span><span class="p">,</span> <span class="n">static</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_outparam</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;transmat&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;.aff12.1D&#39;</span><span class="p">)</span>
        <span class="n">cmd01</span> <span class="o">=</span> <span class="s2">&quot;N4BiasFieldCorrection -i </span><span class="si">{anat}</span><span class="s2"> -o </span><span class="si">{temp_01}</span><span class="s2">&quot;</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_command</span><span class="p">(</span><span class="n">cmd01</span><span class="p">)</span>
        <span class="n">cmd02</span> <span class="o">=</span> <span class="s2">&quot;N4BiasFieldCorrection -i </span><span class="si">{func}</span><span class="s2"> -o </span><span class="si">{temp_02}</span><span class="s2">&quot;</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_command</span><span class="p">(</span><span class="n">cmd02</span><span class="p">)</span>
        <span class="n">cmd03</span> <span class="o">=</span> <span class="s2">&quot;3dAllineate -prefix </span><span class="si">{output}</span><span class="s2"> -onepass -EPI -base </span><span class="si">{temp_01}</span><span class="s2"> -cmass+xy &quot;</span> \
                <span class="s2">&quot;-1Dmatrix_save </span><span class="si">{transmat}</span><span class="s2"> </span><span class="si">{temp_02}</span><span class="s2">&quot;</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_command</span><span class="p">(</span><span class="n">cmd03</span><span class="p">)</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;Coregistration&#39;</span><span class="p">,</span> <span class="n">surfix</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">output_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="Process.afni_SkullStripAll"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Process.afni_SkullStripAll">[docs]</a>    <span class="k">def</span> <span class="nf">afni_SkullStripAll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">meanfunc</span><span class="p">,</span> <span class="n">surfix</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func</span>
<span class="sd">        meanfunc</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">meanfunc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_input</span><span class="p">(</span><span class="n">meanfunc</span><span class="p">)</span>
        <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_input</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">Step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">mask_filters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;file_tag&#39;</span><span class="p">:</span><span class="s1">&#39;_mask&#39;</span><span class="p">}</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_input</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;mask&#39;</span><span class="p">,</span> <span class="n">input_path</span><span class="o">=</span><span class="n">meanfunc</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="n">mask_filters</span><span class="p">,</span> <span class="n">static</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_input</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="n">input_path</span><span class="o">=</span><span class="n">func</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;3dcalc -prefix </span><span class="si">{output}</span><span class="s1"> -expr &quot;a*step(b)&quot; -a </span><span class="si">{func}</span><span class="s1"> -b </span><span class="si">{mask}</span><span class="s1">&#39;</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="c1"># step.get_executefunc(&#39;test&#39;, verbose=True)</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;Apply_SkullStrip&#39;</span><span class="p">,</span> <span class="n">surfix</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">output_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="Process.afni_ApplyCoregAll"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Process.afni_ApplyCoregAll">[docs]</a>    <span class="k">def</span> <span class="nf">afni_ApplyCoregAll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">coregfunc</span><span class="p">,</span> <span class="n">surfix</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func</span>
<span class="sd">        coregfunc</span>
<span class="sd">        surfix</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">coregfunc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_input</span><span class="p">(</span><span class="n">coregfunc</span><span class="p">)</span>
        <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_input</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">Step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">tform_filters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ext&#39;</span><span class="p">:</span><span class="s1">&#39;.aff12.1D&#39;</span><span class="p">}</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_input</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;tform&#39;</span><span class="p">,</span> <span class="n">input_path</span><span class="o">=</span><span class="n">coregfunc</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="n">tform_filters</span><span class="p">,</span> <span class="n">static</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_input</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;coreg&#39;</span><span class="p">,</span> <span class="n">input_path</span><span class="o">=</span><span class="n">coregfunc</span><span class="p">,</span> <span class="n">static</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_input</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="n">input_path</span><span class="o">=</span><span class="n">func</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;3dAllineate -prefix </span><span class="si">{output}</span><span class="s1"> -master </span><span class="si">{coreg}</span><span class="s1"> -1Dmatrix_apply </span><span class="si">{tform}</span><span class="s1"> </span><span class="si">{func}</span><span class="s1">&#39;</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="c1"># step.get_executefunc(&#39;test&#39;, verbose=True)</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;Apply_Coreg&#39;</span><span class="p">,</span> <span class="n">surfix</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">output_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="Process.afni_SpatialNorm"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Process.afni_SpatialNorm">[docs]</a>    <span class="k">def</span> <span class="nf">afni_SpatialNorm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">anat</span><span class="p">,</span> <span class="n">tmpobj</span><span class="p">,</span> <span class="n">surfix</span><span class="o">=</span><span class="s1">&#39;anat&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        anat</span>
<span class="sd">        tmpobj</span>
<span class="sd">        surfix</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">anat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_input</span><span class="p">(</span><span class="n">anat</span><span class="p">)</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">Step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_input</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat&#39;</span><span class="p">,</span> <span class="n">input_path</span><span class="o">=</span><span class="n">anat</span><span class="p">,</span> <span class="n">static</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_staticinput</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;tmpobj&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">tmpobj</span><span class="o">.</span><span class="n">template_path</span><span class="p">)</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_outparam</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;transmat&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;.aff12.1D&#39;</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;3dAllineate -prefix </span><span class="si">{output}</span><span class="s1"> -twopass -cmass+xy -zclip -conv 0.01 -base </span><span class="si">{tmpobj}</span><span class="s1"> &#39;</span> \
              <span class="s1">&#39;-cost crM -check nmi -warp shr -1Dmatrix_save </span><span class="si">{transmat}</span><span class="s1"> </span><span class="si">{anat}</span><span class="s1">&#39;</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="c1"># step.get_executefunc(&#39;test&#39;, verbose=True)</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;SpatialNorm&#39;</span><span class="p">,</span> <span class="n">surfix</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">normanat</span><span class="o">=</span><span class="n">output_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="Process.afni_ApplySpatialNorm"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Process.afni_ApplySpatialNorm">[docs]</a>    <span class="k">def</span> <span class="nf">afni_ApplySpatialNorm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">normanat</span><span class="p">,</span> <span class="n">surfix</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func</span>
<span class="sd">        normanat</span>
<span class="sd">        surfix</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_input</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="n">normanat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_input</span><span class="p">(</span><span class="n">normanat</span><span class="p">)</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">Step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_input</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="n">input_path</span><span class="o">=</span><span class="n">func</span><span class="p">)</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_input</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;normanat&#39;</span><span class="p">,</span> <span class="n">input_path</span><span class="o">=</span><span class="n">normanat</span><span class="p">,</span> <span class="n">static</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">transmat_filter</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ext&#39;</span><span class="p">:</span><span class="s1">&#39;.aff12.1D&#39;</span><span class="p">}</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_input</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;transmat&#39;</span><span class="p">,</span> <span class="n">input_path</span><span class="o">=</span><span class="n">normanat</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="n">transmat_filter</span><span class="p">,</span> <span class="n">static</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;3dAllineate -prefix </span><span class="si">{output}</span><span class="s1"> -master </span><span class="si">{normanat}</span><span class="s1"> -warp shr -1Dmatrix_apply </span><span class="si">{transmat}</span><span class="s1"> </span><span class="si">{func}</span><span class="s1">&#39;</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="c1"># step.get_executefunc(&#39;test&#39;, verbose=True)</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;ApplySpatialNorm&#39;</span><span class="p">,</span> <span class="n">surfix</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">normfunc</span><span class="o">=</span><span class="n">output_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="Process.afni_SpatialSmoothing"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Process.afni_SpatialSmoothing">[docs]</a>    <span class="k">def</span> <span class="nf">afni_SpatialSmoothing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">surfix</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        anat</span>
<span class="sd">        tmpobj</span>
<span class="sd">        surfix</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_input</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">Step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_input</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="n">input_path</span><span class="o">=</span><span class="n">func</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fwhm</span><span class="p">:</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">raiseerror</span><span class="p">(</span><span class="n">messages</span><span class="o">.</span><span class="n">Errors</span><span class="o">.</span><span class="n">InputValueError</span><span class="p">,</span> <span class="s1">&#39;the FWHM value have to specified&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">step</span><span class="o">.</span><span class="n">set_staticinput</span><span class="p">(</span><span class="s1">&#39;fwhm&#39;</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;3dBlurInMask -prefix </span><span class="si">{output}</span><span class="s1"> -FWHM </span><span class="si">{fwhm}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">mask</span><span class="p">:</span>
            <span class="n">step</span><span class="o">.</span><span class="n">set_staticinput</span><span class="p">(</span><span class="s1">&#39;mask&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
            <span class="n">cmd</span> <span class="o">+=</span> <span class="s1">&#39; -mask </span><span class="si">{mask}</span><span class="s1">&#39;</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="s1">&#39; -quiet </span><span class="si">{func}</span><span class="s1">&#39;</span>
        <span class="n">step</span><span class="o">.</span><span class="n">set_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="c1"># step.get_executefunc(&#39;test&#39;, verbose=True)</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;SpatialSmoothing&#39;</span><span class="p">,</span> <span class="n">surfix</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">output_path</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">processing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">subjects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subjects</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sessions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sessions</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">executed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">exists</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">d</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_history</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">step</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exists</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_history</span><span class="p">[</span><span class="n">step</span><span class="p">]</span>
        <span class="n">n_hist</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_history</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">output</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_hist</span><span class="p">),</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_history</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">steps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_history</span><span class="p">[</span><span class="n">step</span><span class="p">]</span> <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>

<div class="viewcode-block" id="Process.reset"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Process.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; reset subject and session information</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">subjects</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_subjects</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">subjects</span><span class="p">[:])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">single_session</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sessions</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">sessions</span><span class="p">[:])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Attributes [subjects, sessions] are reset to default value.&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Process.init_proc"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Process.init_proc">[docs]</a>    <span class="k">def</span> <span class="nf">init_proc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Initiate process folder</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Process object is initiated with </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">processing</span><span class="p">))</span>
        <span class="n">history</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="s1">&#39;.proc_hisroty&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">history</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">history</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_history</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;History file is loaded&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">history</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_history</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span></div>

<div class="viewcode-block" id="Process.init_step"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Process.init_step">[docs]</a>    <span class="k">def</span> <span class="nf">init_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Initiate step</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        path : str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">get_step_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">ds_type</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">raiseerror</span><span class="p">(</span><span class="n">messages</span><span class="o">.</span><span class="n">Errors</span><span class="o">.</span><span class="n">InitiationFailure</span><span class="p">,</span> <span class="s1">&#39;Error on initiating step&#39;</span><span class="p">)</span></div>

    <span class="c1"># def init_report(self, title): #TODO: method for preparing reports</span>
    <span class="c1">#     path = os.path.join(self._prjobj.path, self._prjobj.ds_type[2],</span>
    <span class="c1">#                         self.processing, title)</span>
    <span class="c1">#     methods.mkdir(os.path.join(self._prjobj.path, self._prjobj.ds_type[2],</span>
    <span class="c1">#                                self.processing), path)</span>
    <span class="c1">#     self._prjobj.scan_prj()</span>
    <span class="c1">#     return path</span>

<div class="viewcode-block" id="Process.save_history"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Process.save_history">[docs]</a>    <span class="k">def</span> <span class="nf">save_history</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">history</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="s1">&#39;.proc_hisroty&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">history</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_history</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;History file is saved at &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">history</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="Step"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Step">[docs]</a><span class="k">class</span> <span class="nc">Step</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Template for a processing step</span>

<span class="sd">    This class simply allows you to design processing steps, that needs to combine multiple command line tools in</span>
<span class="sd">    several fMRI imaging package such as AFNI, ANTs, and FSL.</span>
<span class="sd">    The fundamental mechanism is that by applying given inputs, outputs, and command, this class generating</span>
<span class="sd">    customized function and executed it.</span>

<span class="sd">    - data structure -</span>
<span class="sd">    &#39;dataset&#39;   : the template that storing the structure of an input source</span>
<span class="sd">    &#39;oppset&#39;    : the template that storing the structure of an output parameter, such as motion parameter</span>
<span class="sd">                and transformation profiles.</span>
<span class="sd">    &#39;cmdset&#39;    : the template that storing the structure of executing commands including variables</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Dataset&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;input_path&#39;</span><span class="p">,</span> <span class="s1">&#39;static&#39;</span><span class="p">])</span>       <span class="c1"># dataset template</span>
    <span class="n">oppset</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;OutputParam&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;prefix&#39;</span><span class="p">,</span> <span class="s1">&#39;ext&#39;</span><span class="p">])</span>           <span class="c1"># output_param template</span>
    <span class="n">cmdset</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Command&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;command&#39;</span><span class="p">,</span> <span class="s1">&#39;option&#39;</span><span class="p">])</span>           <span class="c1"># command template</span>
    <span class="n">mthset</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Method&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;args&#39;</span><span class="p">,</span> <span class="s1">&#39;kwargs&#39;</span><span class="p">])</span>               <span class="c1"># method template</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">procobj</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_procobj</span> <span class="o">=</span> <span class="n">procobj</span>                         <span class="c1"># load Process object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span> <span class="o">=</span> <span class="n">procobj</span><span class="o">.</span><span class="n">processing</span>           <span class="c1"># read Process name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tempfiles</span> <span class="o">=</span> <span class="p">[]</span>                            <span class="c1"># temp file handler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mainset</span> <span class="o">=</span> <span class="kc">None</span>                            <span class="c1"># main input handler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sidesets</span> <span class="o">=</span> <span class="p">[]</span>                             <span class="c1"># side inputs handler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_staticinput</span> <span class="o">=</span> <span class="p">{}</span>                          <span class="c1"># static input handler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_outparam</span> <span class="o">=</span> <span class="p">{}</span>                             <span class="c1"># output_param handler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subjects</span> <span class="o">=</span> <span class="n">procobj</span><span class="o">.</span><span class="n">subjects</span><span class="p">[:]</span>            <span class="c1"># load all subject list from process object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span> <span class="o">=</span> <span class="p">{}</span>                              <span class="c1"># output handler</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sessions</span> <span class="o">=</span> <span class="n">procobj</span><span class="o">.</span><span class="n">sessions</span><span class="p">[:]</span>        <span class="c1"># check single session or not</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sessions</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_commands</span> <span class="o">=</span> <span class="p">[]</span>                             <span class="c1"># executing commands handler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;main&#39;</span><span class="p">:[],</span> <span class="s1">&#39;sides&#39;</span><span class="p">:{}}</span>         <span class="c1"># handler for project obj filtering</span>

<div class="viewcode-block" id="Step.set_input"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Step.set_input">[docs]</a>    <span class="k">def</span> <span class="nf">set_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">input_path</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">static</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Import input dataset</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        input_path :  str</span>
<span class="sd">            datatype or absolute path</span>
<span class="sd">        kw_filters : dict</span>
<span class="sd">            kw_argment filters</span>
<span class="sd">        static : bool</span>
<span class="sd">            True, if this object need to be looped</span>
<span class="sd">            if not, only use first index</span>
<span class="sd">        side : bool</span>
<span class="sd">            True, if this object is side prjobj</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dc</span><span class="p">,</span> <span class="n">ipath</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_dataclass</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">side</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sidesets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">input_path</span><span class="o">=</span><span class="n">ipath</span><span class="p">,</span> <span class="n">static</span><span class="o">=</span><span class="n">static</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filters</span><span class="p">[</span><span class="s1">&#39;sides&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filtercode</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dc</span><span class="p">),</span> <span class="n">ipath</span><span class="p">,</span> <span class="n">filters</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mainset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">input_path</span><span class="o">=</span><span class="n">input_path</span><span class="p">,</span> <span class="n">static</span><span class="o">=</span><span class="n">static</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filters</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filtercode</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dc</span><span class="p">),</span> <span class="n">ipath</span><span class="p">,</span> <span class="n">filters</span><span class="p">)</span></div>

<div class="viewcode-block" id="Step.set_staticinput"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Step.set_staticinput">[docs]</a>    <span class="k">def</span> <span class="nf">set_staticinput</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Import static file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_staticinput</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>

<div class="viewcode-block" id="Step.set_outparam"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Step.set_outparam">[docs]</a>    <span class="k">def</span> <span class="nf">set_outparam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set parameter output files on out_param handler</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            variables for parameter output file</span>
<span class="sd">        output_ext : str</span>
<span class="sd">            for setting extension of the file</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_outparam</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oppset</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="n">ext</span><span class="p">))</span></div>

<div class="viewcode-block" id="Step.set_execmethod"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Step.set_execmethod">[docs]</a>    <span class="k">def</span> <span class="nf">set_execmethod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set structured command on command handler</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        command : str</span>
<span class="sd">            structured command with input and output variables</span>
<span class="sd">        verbose : boolean</span>

<span class="sd">        idx : int</span>
<span class="sd">            Index for replacing the commands on handler</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">idx</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_commands</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="p">[</span><span class="n">var</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_commands</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">command</span><span class="p">,</span> <span class="p">[</span><span class="n">var</span><span class="p">]))</span></div>

<div class="viewcode-block" id="Step.set_command"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Step.set_command">[docs]</a>    <span class="k">def</span> <span class="nf">set_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set structured command on command handler</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        command : str</span>
<span class="sd">            structured command with input and output variables</span>
<span class="sd">        verbose : boolean</span>

<span class="sd">        idx : int</span>
<span class="sd">            Index for replacing the commands on handler</span>
<span class="sd">        stdout : str or None</span>
<span class="sd">            if True, the input string can be used the variable for stand output results of a command</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">objs</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[{\w&#39;}]+&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span> <span class="k">if</span> <span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;{&#39;</span> <span class="ow">and</span> <span class="n">obj</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;}&#39;</span><span class="p">]</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">sideobj</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">sideobj</span><span class="o">.</span><span class="n">static</span><span class="p">)</span> <span class="k">for</span> <span class="n">sideobj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sidesets</span><span class="p">])</span>
        <span class="n">total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_mainset</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mainset</span><span class="o">.</span><span class="n">static</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">totalobjs</span> <span class="o">=</span> <span class="n">total</span><span class="o">.</span><span class="n">keys</span><span class="p">()[:]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">totalobjs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Get list of residual inputs</span>
        <span class="n">residuals</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span> <span class="k">if</span> <span class="n">obj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">totalobjs</span><span class="p">]</span>
        <span class="n">residuals</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">residuals</span> <span class="k">if</span> <span class="s1">&#39;temp&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">]</span>
        <span class="n">residuals</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">residuals</span> <span class="k">if</span> <span class="s1">&#39;output&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">]</span>
        <span class="n">residuals</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">residuals</span> <span class="k">if</span> <span class="n">obj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_staticinput</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="n">residuals</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">residuals</span> <span class="k">if</span> <span class="n">obj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outparam</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>

        <span class="c1"># Check accuracy</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">residuals</span><span class="p">):</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">raiseerror</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="s1">&#39;Too many inputs :</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">residuals</span><span class="p">)))</span>
        <span class="n">output</span> <span class="o">=</span> <span class="s2">&quot;&#39;</span><span class="si">{0}</span><span class="s2">&#39;.format(&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">str_format</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">obj</span> <span class="o">==</span> <span class="s1">&#39;output&#39;</span><span class="p">:</span>
                <span class="n">str_format</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">=</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;temp&#39;</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
                    <span class="n">str_format</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">=os.path.join(temppath, &#39;</span><span class="si">{0}</span><span class="s2">.nii&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_tempfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_staticinput</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">str_format</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">=</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_staticinput</span><span class="p">[</span><span class="n">obj</span><span class="p">]))</span>
                <span class="k">elif</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outparam</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outparam</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span><span class="o">.</span><span class="n">prefix</span><span class="p">:</span>
                        <span class="n">str_format</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">=&#39;</span><span class="si">{1}</span><span class="s2">_&#39;+ methods.splitnifti(output)+&#39;</span><span class="si">{2}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span>
                                                                                                <span class="bp">self</span><span class="o">.</span><span class="n">_outparam</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span>
                                                                                                <span class="bp">self</span><span class="o">.</span><span class="n">_outparam</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span><span class="o">.</span><span class="n">ext</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">str_format</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">=methods.splitnifti(output)+&#39;</span><span class="si">{1}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outparam</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span><span class="o">.</span><span class="n">ext</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">total</span><span class="p">[</span><span class="n">obj</span><span class="p">]:</span>
                        <span class="n">str_format</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">=</span><span class="si">{1}</span><span class="s2">.Abspath&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">obj</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">str_format</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">=</span><span class="si">{1}</span><span class="s2">[i].Abspath&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">obj</span><span class="p">))</span>
        <span class="n">output</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}{1}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">str_format</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">idx</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_commands</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">stdout</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_commands</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">output</span><span class="p">,</span> <span class="n">stdout</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tempfiles</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tempfiles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tempfiles</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span></div>

<div class="viewcode-block" id="Step.get_inputcode"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Step.get_inputcode">[docs]</a>    <span class="k">def</span> <span class="nf">get_inputcode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Put the set inputs values on the lists as a building block of customized function</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        inputcode : str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inputcode</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mainobj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mainset</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sideobjs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sidesets</span><span class="p">[:]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">sideobjs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mainobj</span><span class="o">.</span><span class="n">static</span><span class="p">:</span>
                <span class="n">inputcode</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> = self._prjobj(</span><span class="si">{1}</span><span class="s1">)[0]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mainobj</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filters</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">])]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inputcode</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> = self._prjobj(</span><span class="si">{1}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mainobj</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filters</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">])]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">raiseerror</span><span class="p">(</span><span class="ne">NameError</span><span class="p">,</span> <span class="s1">&#39;Main input is not defined&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sideobjs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sideobj</span> <span class="ow">in</span> <span class="n">sideobjs</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">sideobj</span><span class="o">.</span><span class="n">name</span>
                <span class="k">if</span> <span class="n">sideobj</span><span class="o">.</span><span class="n">static</span><span class="p">:</span>
                    <span class="n">inputcode</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> = self._prjobj(</span><span class="si">{1}</span><span class="s1">)[0]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filters</span><span class="p">[</span><span class="s1">&#39;sides&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">inputcode</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> = self._prjobj(</span><span class="si">{1}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filters</span><span class="p">[</span><span class="s1">&#39;sides&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">inputcode</span></div>

<div class="viewcode-block" id="Step.get_filtercode"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Step.get_filtercode">[docs]</a>    <span class="k">def</span> <span class="nf">get_filtercode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">input_path</span><span class="p">,</span> <span class="n">filters</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Generate list of filtering based keywords based on set input values</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        foldercode : str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dataclass</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
            <span class="n">output_filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">dataclass</span><span class="p">,</span> <span class="s1">&#39;&quot;</span><span class="si">{0}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">input_path</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">dataclass</span><span class="p">,</span> <span class="s1">&#39;&quot;</span><span class="si">{0}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">),</span> <span class="s1">&#39;&quot;</span><span class="si">{0}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">input_path</span><span class="p">)]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="n">output_filters</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;subj&#39;</span><span class="p">,</span> <span class="s1">&#39;sess&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_filters</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;subj&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{key}</span><span class="s1">=&quot;</span><span class="si">{value}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">filters</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
            <span class="n">output_filters</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_filters</span><span class="p">)</span></div>

<div class="viewcode-block" id="Step.get_executefunc"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Step.get_executefunc">[docs]</a>    <span class="k">def</span> <span class="nf">get_executefunc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Step function generator</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">        test : boolean</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        output : str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Define inputs</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span> <span class="k">for</span> <span class="nb">input</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_inputcode</span><span class="p">()]</span>

        <span class="c1"># Depends on the main input type (static or multiple), different structure of function are generated</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mainset</span><span class="o">.</span><span class="n">static</span><span class="p">:</span>    <span class="c1"># if main input datasets only need to process first files for each subject</span>
            <span class="n">body</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">outputs = []&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">output = os.path.join(sub_path, </span><span class="si">{0}</span><span class="s1">.Filename)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mainset</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
                    <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">prefix = methods.splitnifti(os.path.basename(output))&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">flist = [f for f in os.listdir(sub_path)]&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">if len([f for f in flist if prefix in f]):&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">self.logger.info(&quot;The File[</span><span class="si">{0}</span><span class="s1">] is already exist.&quot;.format(output))&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">else:&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">stdout</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_commands</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">body</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="si">{0}</span><span class="s1">, err = methods.shell(</span><span class="si">{1}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)]</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">body</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="si">{0}</span><span class="s1"> = </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stdout</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmd</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">body</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">outputs.append(methods.shell(</span><span class="si">{0}</span><span class="s1">))&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">)]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tempfiles</span><span class="p">:</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">temppath = mkdtemp()&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">self.logger.info(&quot;TempFolder[</span><span class="si">{0}</span><span class="s1">] is generated&quot;.format(temppath))&#39;</span><span class="p">]</span>
                <span class="n">close</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">rmtree(temppath)&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">self.logger.info(&quot;TempFolder[</span><span class="si">{0}</span><span class="s1">] is closed&quot;.format(temppath))&#39;</span><span class="p">]</span>
                <span class="n">body</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">+</span> <span class="n">body</span> <span class="o">+</span> <span class="n">close</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>   <span class="c1"># if main input datasets need to be looped for each subject</span>
            <span class="n">loop</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">outputs = []&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">for i in progressbar(range(len(</span><span class="si">{0}</span><span class="s1">)), desc=&quot;Files&quot;, leave=False):&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mainset</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span>
            <span class="n">body</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">temp_outputs = []&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">output = os.path.join(sub_path, </span><span class="si">{0}</span><span class="s1">[i].Filename)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mainset</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
                    <span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">prefix = methods.splitnifti(os.path.basename(output))&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">flist = [f for f in os.listdir(sub_path)]&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">if len([f for f in flist if prefix in f]):&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">self.logger.info(&quot;The File[</span><span class="si">{0}</span><span class="s1">] is already exist.&quot;.format(output))&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">else:&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">stdout</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_commands</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">body</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="si">{0}</span><span class="s1">, err = methods.shell(</span><span class="si">{1}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)]</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">body</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="si">{0}</span><span class="s1"> = </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stdout</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmd</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">body</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">temp_outputs.append(methods.shell(</span><span class="si">{0}</span><span class="s1">))&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">)]</span>
            <span class="n">body</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">outputs.append(temp_outputs)&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tempfiles</span><span class="p">:</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">temppath = mkdtemp()&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">self.logger.info(&quot;TempFolder[</span><span class="si">{0}</span><span class="s1">] is generated&quot;.format(temppath))&#39;</span><span class="p">]</span>
                <span class="n">close</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">rmtree(temppath)&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">self.logger.info(&quot;TempFolder[</span><span class="si">{0}</span><span class="s1">] is closed&quot;.format(temppath))&#39;</span><span class="p">]</span>
                <span class="n">body</span> <span class="o">=</span> <span class="n">loop</span> <span class="o">+</span> <span class="n">temp</span> <span class="o">+</span> <span class="n">body</span> <span class="o">+</span> <span class="n">close</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">body</span> <span class="o">=</span> <span class="n">loop</span> <span class="o">+</span> <span class="n">body</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sessions</span><span class="p">:</span> <span class="c1"># Check the project is multi-session</span>
            <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;def </span><span class="si">{0}</span><span class="s1">(self, output_path, subj, sess):&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
                      <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">sub_path = os.path.join(output_path, subj, sess)&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">methods.mkdir(sub_path)&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;def </span><span class="si">{0}</span><span class="s1">(self, output_path, subj):&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
                      <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">sub_path = os.path.join(output_path, subj)&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">methods.mkdir(sub_path)&#39;</span><span class="p">]</span>
        <span class="n">footer</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">return outputs</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">]</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="n">filters</span> <span class="o">+</span> <span class="n">body</span> <span class="o">+</span> <span class="n">footer</span>
        <span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span></div>

<div class="viewcode-block" id="Step.run"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Step.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step_name</span><span class="p">,</span> <span class="n">surfix</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Generate loop commands for step</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        step_name : str</span>
<span class="sd">        surfix : str</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_procobj</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_procobj</span><span class="o">.</span><span class="n">_parallel</span><span class="p">:</span>
            <span class="n">thread</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">thread</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_procobj</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Step:[</span><span class="si">{0}</span><span class="s2">] is executed with </span><span class="si">{1}</span><span class="s2"> thread(s).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step_name</span><span class="p">,</span> <span class="n">thread</span><span class="p">))</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_procobj</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">-</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step_name</span><span class="p">,</span> <span class="n">surfix</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sessions</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="n">progressbar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subjects</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Subjects&#39;</span><span class="p">):</span>
                <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
                <span class="n">iteritem</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">_procobj</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span> <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sessions</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">outputs</span> <span class="ow">in</span> <span class="n">progressbar</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">imap_unordered</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="p">,</span> <span class="n">iteritem</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Sessions&#39;</span><span class="p">,</span>
                                          <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">iteritem</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outputs</span><span class="p">):</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">all_outputs</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
                                <span class="n">all_outputs</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;STDOUT:</span><span class="se">\n</span><span class="si">{0}</span><span class="se">\n</span><span class="s1">Message:</span><span class="se">\n</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="k">for</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="ow">in</span> <span class="n">output</span><span class="p">])</span>
                            <span class="n">outputs</span> <span class="o">=</span> <span class="n">all_outputs</span><span class="p">[:]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;STDOUT:</span><span class="se">\n</span><span class="si">{0}</span><span class="se">\n</span><span class="s1">Message:</span><span class="se">\n</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="k">for</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="ow">in</span> <span class="n">outputs</span> <span class="k">if</span> <span class="n">outputs</span><span class="p">]</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;stephistory.log&#39;</span><span class="p">),</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputs</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">subj</span><span class="p">)</span> <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subjects</span><span class="p">]</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dirs</span><span class="p">)</span>
            <span class="n">iteritem</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">_procobj</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">subj</span><span class="p">)</span> <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subjects</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">outputs</span> <span class="ow">in</span> <span class="n">progressbar</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">imap_unordered</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="p">,</span> <span class="n">iteritem</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Subjects&#39;</span><span class="p">,</span>
                                      <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">iteritem</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outputs</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">all_outputs</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
                            <span class="n">all_outputs</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;STDOUT:</span><span class="se">\n</span><span class="si">{0}</span><span class="se">\n</span><span class="s1">Message:</span><span class="se">\n</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="k">for</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="ow">in</span> <span class="n">output</span><span class="p">])</span>
                        <span class="n">outputs</span> <span class="o">=</span> <span class="n">all_outputs</span><span class="p">[:]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;STDOUT:</span><span class="se">\n</span><span class="si">{0}</span><span class="se">\n</span><span class="s1">Message:</span><span class="se">\n</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="k">for</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">]</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;stephistory.log&#39;</span><span class="p">),</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputs</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_procobj</span><span class="o">.</span><span class="n">_history</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">output_path</span><span class="p">)]</span> <span class="o">=</span> <span class="n">output_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_procobj</span><span class="o">.</span><span class="n">save_history</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_procobj</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">output_path</span></div>

<div class="viewcode-block" id="Step.worker"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Step.worker">[docs]</a>    <span class="k">def</span> <span class="nf">worker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The worker for parallel computing</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        args : list</span>
<span class="sd">            Arguments for step execution</span>

<span class="sd">        Returns : str</span>
<span class="sd">            output</span>
<span class="sd">        -------</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">funccode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_executefunc</span><span class="p">(</span><span class="s1">&#39;stepexec&#39;</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">exec</span><span class="p">(</span><span class="n">funccode</span><span class="p">)</span>    <span class="c1"># load step function on memory</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">exec</span><span class="p">(</span><span class="s1">&#39;output = stepexec(*args)&#39;</span><span class="p">)</span>    <span class="c1"># execute function</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="c1"># except IndexError as e:</span>
        <span class="c1">#     methods.raiseerror(ImportError,</span>
        <span class="c1">#                        &#39;[{}] Parsing input dataset Failed, Please check you put the correct inputs&#39;.format(e))</span>
        <span class="k">return</span> <span class="n">output</span></div></div>


<div class="viewcode-block" id="Pipelines"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Pipelines">[docs]</a><span class="k">class</span> <span class="nc">Pipelines</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span> <span class="c1">#TODO: make pipeline for evoked-fMRI preprocessing</span>
    <span class="sd">&quot;&quot;&quot; Pipeline handler</span>

<span class="sd">    this class is major class of PyNIT (for most of general users)</span>
<span class="sd">    Initiate Pipeline with ptoject path - (not project object)</span>

<span class="sd">    avail atributes return currently available pipelines that stored in Reference object</span>

<span class="sd">    Once you initiate this class, you can select the pipeline what you want to execute by</span>
<span class="sd">    &#39;pipe.start(idx)&#39; of &#39;pipe.start(&#39;name of pipeline&#39;)</span>
<span class="sd">    then you can execute the</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prj_path</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logging</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span> <span class="o">=</span> <span class="n">Project</span><span class="p">(</span><span class="n">prj_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_avail</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">avail</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">avail</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_avail</span>

<div class="viewcode-block" id="Pipelines.start"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Pipelines.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Pipelines.close"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Pipelines.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div></div>

<div class="viewcode-block" id="Maskdrawing"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Maskdrawing">[docs]</a><span class="k">class</span> <span class="nc">Maskdrawing</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">pass</span></div>

<span class="c1"># Below classes will be deprecated soon</span>
<div class="viewcode-block" id="Preprocess"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Preprocess">[docs]</a><span class="k">class</span> <span class="nc">Preprocess</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Preprocessing pipeline</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prjobj</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">):</span>
        <span class="n">prjobj</span><span class="o">.</span><span class="n">reset_filters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subjects</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sessions</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span> <span class="o">=</span> <span class="n">prjobj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initiate_pipeline</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">processing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">subjects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subjects</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sessions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sessions</span>

<div class="viewcode-block" id="Preprocess.reset"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Preprocess.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">subjects</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_subjects</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">subjects</span><span class="p">[:])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">single_session</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sessions</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">sessions</span><span class="p">[:])</span></div>

<div class="viewcode-block" id="Preprocess.initiate_pipeline"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Preprocess.initiate_pipeline">[docs]</a>    <span class="k">def</span> <span class="nf">initiate_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">):</span>
        <span class="n">pipe_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">ds_type</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pipeline</span><span class="p">)</span>
        <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">pipe_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span> <span class="o">=</span> <span class="n">pipeline</span></div>

<div class="viewcode-block" id="Preprocess.init_step"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Preprocess.init_step">[docs]</a>    <span class="k">def</span> <span class="nf">init_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stepname</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">:</span>
            <span class="n">steppath</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">get_step_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stepname</span><span class="p">)</span>
            <span class="n">steppath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">ds_type</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">steppath</span><span class="p">)</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">steppath</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">steppath</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">messages</span><span class="o">.</span><span class="n">PipelineNotSet</span></div>

<div class="viewcode-block" id="Preprocess.seedbased_dynamic_connectivity"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Preprocess.seedbased_dynamic_connectivity">[docs]</a>    <span class="k">def</span> <span class="nf">seedbased_dynamic_connectivity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">winsize</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Seed-based dynamic connectivity using sliding windows # TODO: use this methods as model</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func : str</span>
<span class="sd">            Root path for input dataset</span>
<span class="sd">        seed : str</span>
<span class="sd">            Absolute path for seed image</span>
<span class="sd">        winsize : int</span>
<span class="sd">            Size of sliding window</span>
<span class="sd">        step : int</span>
<span class="sd">            Moving step for sliding window</span>
<span class="sd">        dtype : str</span>
<span class="sd">            Surfix for output folder</span>
<span class="sd">        kwargs : dict</span>
<span class="sd">            Options (Nothing available)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        path : dict</span>
<span class="sd">            output path</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_dataclass</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SeedBaseDynamicConnectivityMap-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
        <span class="n">step01</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;SeedBaseDynamicConnectivityMap-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">seed</span><span class="p">):</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">raiseerror</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="s1">&#39;Input file does not exist.&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">processor</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">temppath</span><span class="p">,</span> <span class="n">finfo</span><span class="p">,</span> <span class="n">seed_path</span><span class="p">,</span> <span class="n">winsize</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
            <span class="n">temp_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temppath</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.nii&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dTcorr1D&#39;</span><span class="p">,</span> <span class="n">temp_path</span><span class="p">,</span>
                             <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&#39;[</span><span class="si">{1}</span><span class="s2">..</span><span class="si">{2}</span><span class="s2">]&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">winsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                             <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&#39;{{</span><span class="si">{1}</span><span class="s2">..</span><span class="si">{2}</span><span class="s2">}}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">seed_path</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">winsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">worker</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            func</span>
<span class="sd">            args</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">processor</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">start_process</span><span class="p">():</span>
            <span class="nb">print</span> <span class="s1">&#39;Starting&#39;</span><span class="p">,</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">current_process</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>

        <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="n">progressbar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Subjects&#39;</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-Subject: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">single_session</span><span class="p">:</span>
                <span class="n">epi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">progressbar</span><span class="p">(</span><span class="n">epi</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Files&#39;</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                    <span class="c1"># Check dimension</span>
                    <span class="n">total</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">shell</span><span class="p">(</span><span class="s1">&#39;3dinfo -nv </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">methods</span><span class="o">.</span><span class="n">raiseerror</span><span class="p">(</span><span class="ne">NameError</span><span class="p">,</span> <span class="s1">&#39;Cannot load: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                    <span class="n">total</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">total</span> <span class="o">&lt;=</span> <span class="n">winsize</span><span class="p">:</span>
                        <span class="n">methods</span><span class="o">.</span><span class="n">raiseerror</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span>
                                           <span class="s1">&#39;Please use proper windows size: [less than </span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">total</span><span class="p">)))</span>
                    <span class="n">seed_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">.1D&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">methods</span><span class="o">.</span><span class="n">splitnifti</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">)))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dmaskave&#39;</span><span class="p">,</span> <span class="n">seed_path</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">seed</span><span class="p">)</span>
                    <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_path</span><span class="p">):</span>
                        <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s1">&#39;.dtmp&#39;</span><span class="p">)</span>
                        <span class="n">temppath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;.dtmp&#39;</span><span class="p">)</span>
                        <span class="n">list_of_files</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">cpu</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
                        <span class="n">cpu</span> <span class="o">=</span> <span class="n">cpu</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">cpu</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>
                        <span class="n">pool</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="n">start_process</span><span class="p">)</span>
                        <span class="n">iteritem</span> <span class="o">=</span> <span class="p">[(</span><span class="n">list_of_files</span><span class="p">,</span> <span class="n">temppath</span><span class="p">,</span> <span class="n">finfo</span><span class="p">,</span> <span class="n">seed_path</span><span class="p">,</span> <span class="n">winsize</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">total</span> <span class="o">-</span> <span class="n">winsize</span><span class="p">,</span> <span class="n">step</span><span class="p">)]</span>
                        <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">progressbar</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">imap_unordered</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="n">iteritem</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Window&#39;</span><span class="p">,</span>
                                                  <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">iteritem</span><span class="p">)</span> <span class="p">,</span><span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                            <span class="k">pass</span>
                        <span class="n">list_of_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">list_of_files</span><span class="p">)</span>
                        <span class="n">methods</span><span class="o">.</span><span class="n">shell</span><span class="p">(</span><span class="s1">&#39;3dTcat -prefix </span><span class="si">{0}</span><span class="s1"> -tr </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">step</span><span class="p">),</span>
                                                                              <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">list_of_files</span><span class="p">)))</span>
                        <span class="n">rmtree</span><span class="p">(</span><span class="n">temppath</span><span class="p">)</span>
                        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="n">progressbar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Sessions&#39;</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                    <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">))</span>
                    <span class="n">epi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">progressbar</span><span class="p">(</span><span class="n">epi</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Files&#39;</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                        <span class="c1"># Check dimension</span>
                        <span class="n">total</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">shell</span><span class="p">(</span><span class="s1">&#39;3dinfo -nv </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">methods</span><span class="o">.</span><span class="n">raiseerror</span><span class="p">(</span><span class="ne">NameError</span><span class="p">,</span> <span class="s1">&#39;Cannot load: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                        <span class="n">total</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">total</span> <span class="o">&lt;=</span> <span class="n">winsize</span><span class="p">:</span>
                            <span class="n">methods</span><span class="o">.</span><span class="n">raiseerror</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span>
                                               <span class="s1">&#39;Please use proper windows size: [less than </span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">total</span><span class="p">)))</span>
                        <span class="n">seed_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span>
                                                 <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">.1D&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">methods</span><span class="o">.</span><span class="n">splitnifti</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">)))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dmaskave&#39;</span><span class="p">,</span> <span class="n">seed_path</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">seed</span><span class="p">)</span>
                        <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_path</span><span class="p">):</span>
                            <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s1">&#39;.dtmp&#39;</span><span class="p">)</span>
                            <span class="n">temppath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;.dtmp&#39;</span><span class="p">)</span>
                            <span class="n">list_of_files</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">cpu</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
                            <span class="n">cpu</span> <span class="o">=</span> <span class="n">cpu</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">cpu</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span>
                            <span class="n">pool</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="n">start_process</span><span class="p">)</span>
                            <span class="n">iteritem</span> <span class="o">=</span> <span class="p">[(</span><span class="n">list_of_files</span><span class="p">,</span> <span class="n">temppath</span><span class="p">,</span> <span class="n">finfo</span><span class="p">,</span> <span class="n">seed_path</span><span class="p">,</span> <span class="n">winsize</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>
                                        <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">total</span> <span class="o">-</span> <span class="n">winsize</span><span class="p">,</span> <span class="n">step</span><span class="p">)]</span>
                            <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">progressbar</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">imap_unordered</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="n">iteritem</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Window&#39;</span><span class="p">,</span>
                                                      <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">iteritem</span><span class="p">),</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                                <span class="k">pass</span>
                            <span class="n">list_of_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">list_of_files</span><span class="p">)</span>
                            <span class="n">methods</span><span class="o">.</span><span class="n">shell</span><span class="p">(</span><span class="s1">&#39;3dTcat -prefix </span><span class="si">{0}</span><span class="s1"> -tr </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">step</span><span class="p">),</span>
                                                                                  <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">list_of_files</span><span class="p">)))</span>
                            <span class="n">rmtree</span><span class="p">(</span><span class="n">temppath</span><span class="p">)</span>
                            <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                            <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;dynamicMap&#39;</span><span class="p">:</span> <span class="n">step01</span><span class="p">}</span></div>

<div class="viewcode-block" id="Preprocess.calculate_seedbased_global_connectivity"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Preprocess.calculate_seedbased_global_connectivity">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_seedbased_global_connectivity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Seed-based Global Connectivity Analysis</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func : str</span>
<span class="sd">            Root path for input dataset</span>
<span class="sd">        seed : str</span>
<span class="sd">            Absolute path for seed image</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        path : dict</span>
<span class="sd">            Absolute path for output</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_dataclass</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SeedBaseConnectivityMap-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
        <span class="n">step01</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;SeedBaseConnectivityMap-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">seed</span><span class="p">):</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">raiseerror</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="s1">&#39;Input file does not exist.&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-Subject: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">single_session</span><span class="p">:</span>
                <span class="n">epi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">epi</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                    <span class="n">seed_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">.1D&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">methods</span><span class="o">.</span><span class="n">splitnifti</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">)))</span>
                    <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dmaskave&#39;</span><span class="p">,</span> <span class="n">seed_path</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">seed</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dTcorr1D&#39;</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">seed_path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; :Session: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sess</span><span class="p">))</span>
                    <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">))</span>
                    <span class="n">epi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">epi</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                        <span class="n">seed_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">.1D&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">methods</span><span class="o">.</span><span class="n">splitnifti</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">)))</span>
                        <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dmaskave&#39;</span><span class="p">,</span> <span class="n">seed_path</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">seed</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dTcorr1D&#39;</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">seed_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;connMap&#39;</span><span class="p">:</span> <span class="n">step01</span><span class="p">}</span></div>

<div class="viewcode-block" id="Preprocess.fisher_transform"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Preprocess.fisher_transform">[docs]</a>    <span class="k">def</span> <span class="nf">fisher_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_dataclass</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FisherTransform-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
        <span class="n">step01</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;FisherTransform-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-Subject: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">single_session</span><span class="p">:</span>
                <span class="n">epi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">epi</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                    <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dcalc&#39;</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;atanh(a)&#39;</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; :Session: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sess</span><span class="p">))</span>
                    <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">))</span>
                    <span class="n">epi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">epi</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                        <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dcalc&#39;</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;atanh(a)&#39;</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;Zmap&#39;</span><span class="p">:</span> <span class="n">step01</span><span class="p">}</span></div>

<div class="viewcode-block" id="Preprocess.group_average"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Preprocess.group_average">[docs]</a>    <span class="k">def</span> <span class="nf">group_average</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subjects</span><span class="p">,</span> <span class="n">sessions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;groupA&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Calculate group average</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func : str</span>
<span class="sd">            Root path for input dataset</span>
<span class="sd">        subjects : list</span>
<span class="sd">            list of the subjects for group</span>
<span class="sd">        sessions : list</span>
<span class="sd">            list of the sessions that want to calculate average</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_dataclass</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;AverageGroupData-</span><span class="si">{0}</span><span class="s1">: [</span><span class="si">{1}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subjects</span><span class="p">)))</span>
        <span class="n">step01</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_step</span><span class="p">(</span><span class="s1">&#39;AverageGRoupData-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">group</span><span class="p">))</span>
        <span class="n">root_output</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="s1">&#39;AllSubjects&#39;</span><span class="p">)</span>
        <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">root_output</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sessions</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*Average image will be calculated for each session listed in: [</span><span class="si">{0}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sessions</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="n">sessions</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-Session: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sess</span><span class="p">))</span>
                <span class="n">sess_output</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_output</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span>
                <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">sess_output</span><span class="p">)</span>
                <span class="n">epi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="o">*</span><span class="n">subjects</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Abspath</span>
                <span class="n">grouplist</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">epi</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; :List of subjects in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sess</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">grouplist</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dMean&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sess_output</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">.nii.gz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">sess</span><span class="p">)),</span>
                                 <span class="o">*</span><span class="n">grouplist</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">epi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">subjects</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Abspath</span>
            <span class="n">grouplist</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">epi</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;:List of subjects in this group&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">grouplist</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dMean&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_output</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">.nii.gz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">group</span><span class="p">)),</span>
                             <span class="o">*</span><span class="n">grouplist</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;groupavr&quot;</span><span class="p">:</span> <span class="n">step01</span><span class="p">}</span></div>

<div class="viewcode-block" id="Preprocess.cbv_meancalculation"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Preprocess.cbv_meancalculation">[docs]</a>    <span class="k">def</span> <span class="nf">cbv_meancalculation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; CBV image preparation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_dataclass</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MotionCorrection&quot;</span><span class="p">)</span>
        <span class="n">step01</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;MotionCorrection-CBVinduction&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-Subject: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">single_session</span><span class="p">:</span>
                <span class="n">cbv_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">cbv_img</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dvolreg&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; :Session: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sess</span><span class="p">))</span>
                    <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">))</span>
                    <span class="n">cbv_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">cbv_img</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dvolreg&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span>
                                         <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
        <span class="n">step02</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;MeanImageCalculation-BOLD&#39;</span><span class="p">)</span>
        <span class="n">step03</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;MeanImageCalculation-CBV&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MeanImageCalculation-BOLD&amp;CBV&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-Subject: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step03</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">single_session</span><span class="p">:</span>
                <span class="n">cbv_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">step01</span><span class="p">),</span> <span class="n">subj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">cbv_img</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                    <span class="n">shape</span> <span class="o">=</span> <span class="n">ImageObj</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dTstat&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span>
                                     <span class="s2">&quot;</span><span class="si">{path}</span><span class="s2">&#39;[</span><span class="si">{start}</span><span class="s2">..</span><span class="si">{end}</span><span class="s2">]&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span>
                                                                       <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                                       <span class="c1"># end=20))</span>
                                                                       <span class="n">end</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">3</span><span class="p">))))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dTstat&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step03</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span>
                                     <span class="s2">&quot;</span><span class="si">{path}</span><span class="s2">&#39;[</span><span class="si">{start}</span><span class="s2">..</span><span class="si">{end}</span><span class="s2">]&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span>
                                                                       <span class="c1"># start=int(shape[-1]-21),</span>
                                                                       <span class="n">start</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">3</span><span class="p">),</span>
                                                                       <span class="n">end</span><span class="o">=</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; :Session: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sess</span><span class="p">))</span>
                    <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step03</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">))</span>
                    <span class="n">cbv_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">step01</span><span class="p">),</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">cbv_img</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                        <span class="n">shape</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dTstat&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span>
                                         <span class="s2">&quot;</span><span class="si">{path}</span><span class="s2">&#39;[</span><span class="si">{start}</span><span class="s2">..</span><span class="si">{end}</span><span class="s2">]&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span>
                                                                           <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                                           <span class="c1"># end=20))</span>
                                                                           <span class="n">end</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">3</span><span class="p">))))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dTstat&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step03</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span>
                                         <span class="s2">&quot;</span><span class="si">{path}</span><span class="s2">&#39;[</span><span class="si">{start}</span><span class="s2">..</span><span class="si">{end}</span><span class="s2">]&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span>
                                                                           <span class="n">start</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">3</span><span class="p">),</span>
                                                                           <span class="c1"># start=int(shape[-1]-21),</span>
                                                                           <span class="n">end</span><span class="o">=</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;CBVinduction&#39;</span><span class="p">:</span> <span class="n">step01</span><span class="p">,</span> <span class="s1">&#39;meanBOLD&#39;</span><span class="p">:</span> <span class="n">step02</span><span class="p">,</span> <span class="s1">&#39;meanCBV&#39;</span><span class="p">:</span> <span class="n">step03</span><span class="p">}</span></div>

<div class="viewcode-block" id="Preprocess.mean_calculation"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Preprocess.mean_calculation">[docs]</a>    <span class="k">def</span> <span class="nf">mean_calculation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; BOLD image preparation</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func       : str</span>
<span class="sd">            Datatype or absolute path of the input mean functional image</span>
<span class="sd">        dtype      : str</span>
<span class="sd">            Surfix for step path</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        step_paths : dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_dataclass</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="n">step01</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;InitialPreparation-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MotionCorrection&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-Subject: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">single_session</span><span class="p">:</span>
                <span class="n">finfo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dvolreg&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; :Session: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sess</span><span class="p">))</span>
                    <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">))</span>
                    <span class="n">finfo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dvolreg&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
        <span class="n">step02</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;MeanImageCalculation-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MeanImageCalculation-</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-Subject: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">single_session</span><span class="p">:</span>
                <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">step01</span><span class="p">),</span> <span class="n">subj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">funcs</span> <span class="o">=</span> <span class="n">funcs</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">funcs</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dTstat&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">funcs</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span>
                                 <span class="n">funcs</span><span class="o">.</span><span class="n">Abspath</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; :Session: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sess</span><span class="p">))</span>
                    <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">))</span>
                    <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">step01</span><span class="p">),</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="n">funcs</span> <span class="o">=</span> <span class="n">funcs</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">funcs</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dTstat&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">funcs</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span>
                                     <span class="n">funcs</span><span class="o">.</span><span class="n">Abspath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;firstfunc&#39;</span><span class="p">:</span> <span class="n">step01</span><span class="p">,</span> <span class="s1">&#39;meanfunc&#39;</span><span class="p">:</span> <span class="n">step02</span><span class="p">}</span></div>

<div class="viewcode-block" id="Preprocess.slicetiming_correction"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Preprocess.slicetiming_correction">[docs]</a>    <span class="k">def</span> <span class="nf">slicetiming_correction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">tr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tpattern</span><span class="o">=</span><span class="s1">&#39;altplus&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Corrects for slice time differences when individual 2D slices are recorded over a 3D image</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func       : str</span>
<span class="sd">            Data type or absolute path of the input functional image</span>
<span class="sd">        tr         : int</span>
<span class="sd">        tpattern   : str</span>
<span class="sd">        dtype      : str</span>
<span class="sd">            Surfix for the step paths</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        step_paths : dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_dataclass</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="c1"># if os.path.exists(func):</span>
        <span class="c1">#     dataclass = 1</span>
        <span class="c1">#     func = methods.path_splitter(func)[-1]</span>
        <span class="c1"># else:</span>
        <span class="c1">#     dataclass = 0</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SliceTimingCorrection-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
        <span class="n">step01</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;SliceTimingCorrection-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-Subject: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">single_session</span><span class="p">:</span>
                <span class="n">epi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">epi</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dTshift&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span>
                                     <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">tr</span><span class="o">=</span><span class="n">tr</span><span class="p">,</span> <span class="n">tpattern</span><span class="o">=</span><span class="n">tpattern</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; :Session: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sess</span><span class="p">))</span>
                    <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">))</span>
                    <span class="n">epi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">epi</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dTshift&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span>
                                         <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">tr</span><span class="o">=</span><span class="n">tr</span><span class="p">,</span> <span class="n">tpattern</span><span class="o">=</span><span class="n">tpattern</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">step01</span><span class="p">}</span></div>

<div class="viewcode-block" id="Preprocess.motion_correction"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Preprocess.motion_correction">[docs]</a>    <span class="k">def</span> <span class="nf">motion_correction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">baseidx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">meancbv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Corrects for motion artifacts in the  input functional image</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func       : str</span>
<span class="sd">            Datatype or absolute step path for the input functional image</span>
<span class="sd">        base       : str</span>
<span class="sd">            Datatype or absolute step path for the mean functional image</span>
<span class="sd">        baseidx    :</span>
<span class="sd">        meancbv   :</span>
<span class="sd">        dtype      : str</span>
<span class="sd">            Surfix for the step path</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        step_paths : dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s0_dataclass</span><span class="p">,</span> <span class="n">s0_func</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_dataclass</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MotionCorrection-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
        <span class="n">step01</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;MotionCorrection-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-Subject: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">single_session</span><span class="p">:</span>
                <span class="n">epi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">s0_dataclass</span><span class="p">,</span> <span class="n">s0_func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">base</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                        <span class="n">meanimg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">base</span><span class="p">),</span> <span class="n">subj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                        <span class="n">meanimg</span> <span class="o">=</span> <span class="n">meanimg</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Abspath</span><span class="p">[</span><span class="n">baseidx</span><span class="p">]</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">meanimg</span> <span class="o">=</span> <span class="n">base</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">meanimg</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">epi</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dvolreg&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span>
                                     <span class="n">base_slice</span><span class="o">=</span><span class="n">meanimg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; :Session: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sess</span><span class="p">))</span>
                    <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">))</span>
                    <span class="n">epi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">s0_dataclass</span><span class="p">,</span> <span class="n">s0_func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">base</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                            <span class="n">meanimg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">base</span><span class="p">),</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span>
                            <span class="n">meanimg</span> <span class="o">=</span> <span class="n">meanimg</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Abspath</span><span class="p">[</span><span class="n">baseidx</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">meanimg</span> <span class="o">=</span> <span class="n">base</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">meanimg</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">epi</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dvolreg&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span>
                                         <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">base_slice</span><span class="o">=</span><span class="n">meanimg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">meancbv</span><span class="p">:</span>
            <span class="c1"># Calculate mean image for each 3D+time data</span>
            <span class="n">s1_dataclass</span><span class="p">,</span> <span class="n">s1_func</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_dataclass</span><span class="p">(</span><span class="n">step01</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MeanCalculation-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s1_func</span><span class="p">))</span>
            <span class="n">step02</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;MeanFunctionalImages-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-Subject: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
                <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">single_session</span><span class="p">:</span>
                    <span class="n">epi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">s1_dataclass</span><span class="p">,</span> <span class="n">s1_func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">epi</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dTstat&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span>
                                         <span class="n">mean</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; :Session: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sess</span><span class="p">))</span>
                        <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">))</span>
                        <span class="n">epi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">s1_dataclass</span><span class="p">,</span> <span class="n">s1_func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">epi</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dTstat&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span>
                                             <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># Realigning each run of CBV images</span>
            <span class="n">s2_dataclass</span><span class="p">,</span> <span class="n">s2_func</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_dataclass</span><span class="p">(</span><span class="n">step02</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;IntersubjectRealign-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
            <span class="n">step03</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;InterSubjectRealign-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-Subject: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
                <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step03</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">single_session</span><span class="p">:</span>
                    <span class="n">epi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">s2_dataclass</span><span class="p">,</span> <span class="n">s2_func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">baseimg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">meancbv</span><span class="p">),</span> <span class="n">subj</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Abspath</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">baseimg</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">epi</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                        <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step03</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dAllineate&#39;</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span>
                                         <span class="n">base</span><span class="o">=</span><span class="n">baseimg</span><span class="p">,</span> <span class="n">warp</span><span class="o">=</span><span class="s1">&#39;sho&#39;</span><span class="p">,</span>
                                         <span class="n">matrix_save</span><span class="o">=</span><span class="n">methods</span><span class="o">.</span><span class="n">splitnifti</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.aff12.1D&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; :Session: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sess</span><span class="p">))</span>
                        <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step03</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">))</span>
                        <span class="n">epi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">s2_dataclass</span><span class="p">,</span> <span class="n">s2_func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">baseimg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">meancbv</span><span class="p">),</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span>
                            <span class="n">baseimg</span> <span class="o">=</span> <span class="n">baseimg</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Abspath</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">baseimg</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">epi</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                            <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step03</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dAllineate&#39;</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span>
                                             <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="n">baseimg</span><span class="p">,</span> <span class="n">warp</span><span class="o">=</span><span class="s1">&#39;sho&#39;</span><span class="p">,</span>
                                             <span class="n">matrix_save</span><span class="o">=</span><span class="n">methods</span><span class="o">.</span><span class="n">splitnifti</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.aff12.1D&#39;</span><span class="p">)</span>
            <span class="c1"># Realigning each run of CBV images</span>
            <span class="n">s3_dataclass</span><span class="p">,</span> <span class="n">s3_func</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_dataclass</span><span class="p">(</span><span class="n">step03</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;InterSubj-ApplyTranform-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
            <span class="n">step04</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;InterSubj-ApplyTransform-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-Subject: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
                <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step04</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">single_session</span><span class="p">:</span>
                    <span class="n">param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">s3_dataclass</span><span class="p">,</span> <span class="n">s3_func</span><span class="p">,</span> <span class="n">subj</span><span class="p">)</span><span class="o">.</span><span class="n">df</span>
                    <span class="n">epi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">s1_dataclass</span><span class="p">,</span> <span class="n">s1_func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">epi</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span> <span class="o">!=</span> <span class="n">param</span><span class="o">.</span><span class="n">Filename</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                                <span class="k">raise</span> <span class="n">messages</span><span class="o">.</span><span class="n">ObjectMismatch</span><span class="p">()</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dAllineate&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step04</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span>
                                                 <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">warp</span><span class="o">=</span><span class="s1">&#39;sho&#39;</span><span class="p">,</span>
                                                 <span class="n">matrix_apply</span><span class="o">=</span><span class="n">methods</span><span class="o">.</span><span class="n">splitnifti</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">Abspath</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;.aff12.1D&#39;</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  ::Skipped&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; :Session: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sess</span><span class="p">))</span>
                        <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step04</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">))</span>
                        <span class="n">param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">s3_dataclass</span><span class="p">,</span> <span class="n">s3_func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span><span class="o">.</span><span class="n">df</span>
                        <span class="n">epi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">s1_dataclass</span><span class="p">,</span> <span class="n">s1_func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">epi</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span> <span class="o">!=</span> <span class="n">param</span><span class="o">.</span><span class="n">Filename</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                                    <span class="nb">print</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">,</span> <span class="n">param</span><span class="o">.</span><span class="n">Filename</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                                    <span class="k">raise</span> <span class="n">messages</span><span class="o">.</span><span class="n">ObjectMismatch</span><span class="p">()</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dAllineate&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step04</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span>
                                                    <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">warp</span><span class="o">=</span><span class="s1">&#39;sho&#39;</span><span class="p">,</span>
                                                    <span class="n">matrix_apply</span><span class="o">=</span><span class="n">methods</span><span class="o">.</span><span class="n">splitnifti</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">Abspath</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;.aff12.1D&#39;</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  ::Skipped&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">step04</span><span class="p">,</span> <span class="s1">&#39;mparam&#39;</span><span class="p">:</span> <span class="n">step01</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">step01</span><span class="p">}</span></div>

<div class="viewcode-block" id="Preprocess.maskdrawing_preparation"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Preprocess.maskdrawing_preparation">[docs]</a>    <span class="k">def</span> <span class="nf">maskdrawing_preparation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meanfunc</span><span class="p">,</span> <span class="n">anat</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zaxis</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        meanfunc</span>
<span class="sd">        anat</span>
<span class="sd">        padding</span>
<span class="sd">        zaxis</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">f_dataclass</span><span class="p">,</span> <span class="n">meanfunc</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_dataclass</span><span class="p">(</span><span class="n">meanfunc</span><span class="p">)</span>
        <span class="n">a_dataclass</span><span class="p">,</span> <span class="n">anat</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_dataclass</span><span class="p">(</span><span class="n">anat</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MaskDrawing-</span><span class="si">{}</span><span class="s1"> &amp; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">meanfunc</span><span class="p">,</span> <span class="n">anat</span><span class="p">))</span>

        <span class="n">step01</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;MaskDrwaing-func&#39;</span><span class="p">)</span>
        <span class="n">step02</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;MaskDrawing-anat&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-Subject: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">single_session</span><span class="p">:</span>
                <span class="n">epi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">f_dataclass</span><span class="p">,</span> <span class="n">meanfunc</span><span class="p">,</span> <span class="n">subj</span><span class="p">)</span>
                <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">a_dataclass</span><span class="p">,</span> <span class="n">anat</span><span class="p">,</span> <span class="n">subj</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">epi</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                    <span class="n">epiimg</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">padding</span><span class="p">:</span>
                        <span class="n">epiimg</span><span class="o">.</span><span class="n">padding</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">zaxis</span><span class="p">)</span>
                    <span class="n">epiimg</span><span class="o">.</span><span class="n">save_as</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">t2</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                    <span class="n">t2img</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">padding</span><span class="p">:</span>
                        <span class="n">t2img</span><span class="o">.</span><span class="n">padding</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">zaxis</span><span class="p">)</span>
                    <span class="n">t2img</span><span class="o">.</span><span class="n">save_as</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; :Session: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sess</span><span class="p">))</span>
                    <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">))</span>
                    <span class="n">epi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">f_dataclass</span><span class="p">,</span> <span class="n">meanfunc</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span>
                    <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">a_dataclass</span><span class="p">,</span> <span class="n">anat</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">epi</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                        <span class="n">epiimg</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">padding</span><span class="p">:</span>
                            <span class="n">epiimg</span><span class="o">.</span><span class="n">padding</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">zaxis</span><span class="p">)</span>
                        <span class="n">epiimg</span><span class="o">.</span><span class="n">save_as</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">t2</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">)</span>
                        <span class="n">t2img</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">padding</span><span class="p">:</span>
                            <span class="n">t2img</span><span class="o">.</span><span class="n">padding</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">zaxis</span><span class="p">)</span>
                        <span class="n">t2img</span><span class="o">.</span><span class="n">save_as</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;meanfunc&#39;</span><span class="p">:</span> <span class="n">step01</span><span class="p">,</span> <span class="s1">&#39;anat&#39;</span><span class="p">:</span> <span class="n">step02</span><span class="p">}</span></div>

<div class="viewcode-block" id="Preprocess.compute_skullstripping"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Preprocess.compute_skullstripping">[docs]</a>    <span class="k">def</span> <span class="nf">compute_skullstripping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meanfunc</span><span class="p">,</span> <span class="n">anat</span><span class="p">,</span> <span class="n">padded</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zaxis</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;z&#39;</span><span class="p">}</span>
        <span class="n">f_dataclass</span><span class="p">,</span> <span class="n">meanfunc</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_dataclass</span><span class="p">(</span><span class="n">meanfunc</span><span class="p">)</span>
        <span class="n">a_dataclass</span><span class="p">,</span> <span class="n">anat</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_dataclass</span><span class="p">(</span><span class="n">anat</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SkullStripping-</span><span class="si">{}</span><span class="s1"> &amp; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">meanfunc</span><span class="p">,</span> <span class="n">anat</span><span class="p">))</span>
        <span class="n">step01</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;SkullStripped-meanfunc&#39;</span><span class="p">)</span>
        <span class="n">step02</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;SkullStripped-anat&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-Subject: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">single_session</span><span class="p">:</span>
                <span class="c1"># Load image paths</span>
                <span class="n">epi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">meanfunc</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="s1">&#39;_mask&#39;</span><span class="p">)</span>
                <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">anat</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="s1">&#39;_mask&#39;</span><span class="p">)</span>
                <span class="c1"># Load mask image obj</span>
                <span class="n">epimask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">meanfunc</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">file_tag</span><span class="o">=</span><span class="s1">&#39;_mask&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Abspath</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">t2mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">anat</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">file_tag</span><span class="o">=</span><span class="s1">&#39;_mask&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Abspath</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># Execute process</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">epi</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename of meanfunc: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span>
                    <span class="n">fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dcalc&#39;</span><span class="p">,</span> <span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;a*step(b)&#39;</span><span class="p">,</span>
                                     <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">epimask</span><span class="p">)</span>
                    <span class="n">ss_epi</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">padded</span><span class="p">:</span>
                        <span class="n">exec</span><span class="p">(</span><span class="s1">&#39;ss_epi.crop(</span><span class="si">{}</span><span class="s1">=[1, </span><span class="si">{}</span><span class="s1">])&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">axis</span><span class="p">[</span><span class="n">zaxis</span><span class="p">],</span> <span class="n">ss_epi</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">zaxis</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                        <span class="n">ss_epi</span><span class="o">.</span><span class="n">save_as</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">t2</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename of anat: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span>
                    <span class="n">fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dcalc&#39;</span><span class="p">,</span> <span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;a*step(b)&#39;</span><span class="p">,</span>
                                     <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">t2mask</span><span class="p">)</span>
                    <span class="n">ss_t2</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">padded</span><span class="p">:</span>
                        <span class="n">exec</span><span class="p">(</span><span class="s1">&#39;ss_t2.crop(</span><span class="si">{}</span><span class="s1">=[1, </span><span class="si">{}</span><span class="s1">])&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">axis</span><span class="p">[</span><span class="n">zaxis</span><span class="p">],</span> <span class="n">ss_t2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">zaxis</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="n">ss_t2</span><span class="o">.</span><span class="n">save_as</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; :Session: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sess</span><span class="p">))</span>
                    <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">))</span>
                    <span class="c1"># Load image paths</span>
                    <span class="n">epi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">meanfunc</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="s1">&#39;_mask&#39;</span><span class="p">)</span>
                    <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">anat</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="s1">&#39;_mask&#39;</span><span class="p">)</span>
                    <span class="c1"># Load mask image obj</span>
                    <span class="n">epimask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">meanfunc</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">file_tag</span><span class="o">=</span><span class="s1">&#39;_mask&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Abspath</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">t2mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">anat</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">file_tag</span><span class="o">=</span><span class="s1">&#39;_mask&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Abspath</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="c1"># Execute process</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">epi</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  +Filename of meanfunc: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                        <span class="n">filename</span> <span class="o">=</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span>
                        <span class="n">tpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span>
                        <span class="n">fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tpath</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dcalc&#39;</span><span class="p">,</span> <span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;a*step(b)&#39;</span><span class="p">,</span>
                                         <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">epimask</span><span class="p">)</span>
                        <span class="n">ss_epi</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">padded</span><span class="p">:</span>
                            <span class="n">exec</span><span class="p">(</span><span class="s1">&#39;ss_epi.crop(</span><span class="si">{}</span><span class="s1">=[1, </span><span class="si">{}</span><span class="s1">])&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">axis</span><span class="p">[</span><span class="n">zaxis</span><span class="p">],</span> <span class="n">ss_epi</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">zaxis</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                            <span class="n">ss_epi</span><span class="o">.</span><span class="n">save_as</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">t2</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  +Filename of anat: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                        <span class="n">filename</span> <span class="o">=</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span>
                        <span class="n">tpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span>
                        <span class="n">fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tpath</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dcalc&#39;</span><span class="p">,</span> <span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;a*step(b)&#39;</span><span class="p">,</span>
                                         <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">t2mask</span><span class="p">)</span>
                        <span class="n">ss_t2</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">padded</span><span class="p">:</span>
                            <span class="n">exec</span><span class="p">(</span><span class="s1">&#39;ss_t2.crop(</span><span class="si">{}</span><span class="s1">=[1, </span><span class="si">{}</span><span class="s1">])&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">axis</span><span class="p">[</span><span class="n">zaxis</span><span class="p">],</span> <span class="n">ss_t2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">zaxis</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                            <span class="n">ss_t2</span><span class="o">.</span><span class="n">save_as</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;meanfunc&#39;</span><span class="p">:</span> <span class="n">step01</span><span class="p">,</span> <span class="s1">&#39;anat&#39;</span><span class="p">:</span> <span class="n">step02</span><span class="p">}</span></div>

<div class="viewcode-block" id="Preprocess.timecrop"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Preprocess.timecrop">[docs]</a>    <span class="k">def</span> <span class="nf">timecrop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">crop_loc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func</span>
<span class="sd">        crop_loc</span>
<span class="sd">        dtype</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_dataclass</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;TimeCropped-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
        <span class="n">step01</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;CropTimeAxis-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-Subject: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">single_session</span><span class="p">:</span>
                <span class="c1"># Load image paths</span>
                <span class="n">epi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">)</span>
                <span class="c1"># Execute process</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">epi</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                    <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s1">&#39;.gz&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">output_path</span><span class="p">:</span>
                        <span class="n">output_path</span> <span class="o">+=</span> <span class="s1">&#39;.gz&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dcalc&#39;</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span>
                                     <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&#39;[</span><span class="si">{}</span><span class="s2">..</span><span class="si">{}</span><span class="s2">]&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">crop_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">crop_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; :Session: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sess</span><span class="p">))</span>
                    <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">))</span>
                    <span class="c1"># Load image paths</span>
                    <span class="n">epi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">)</span>
                    <span class="c1"># Execute process</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">epi</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                        <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">)</span>
                        <span class="k">if</span> <span class="s1">&#39;.gz&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">output_path</span><span class="p">:</span>
                            <span class="n">output_path</span> <span class="o">+=</span> <span class="s1">&#39;.gz&#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dcalc&#39;</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span>
                                         <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&#39;[</span><span class="si">{}</span><span class="s2">..</span><span class="si">{}</span><span class="s2">]&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">crop_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">crop_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">step01</span><span class="p">}</span></div>

<div class="viewcode-block" id="Preprocess.coregistration"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Preprocess.coregistration">[docs]</a>    <span class="k">def</span> <span class="nf">coregistration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meanfunc</span><span class="p">,</span> <span class="n">anat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method for mean functional image realignment to anatomical image of same subject</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        meanfunc   : str</span>
<span class="sd">            Datatype or absolute path of the input mean functional image</span>
<span class="sd">        anat       : str</span>
<span class="sd">            Datatype or absolute path of the input anatomical image</span>
<span class="sd">        dtype      : str</span>
<span class="sd">            Surfix for the step path</span>
<span class="sd">        kwargs     :</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        step_paths : dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">f_dataclass</span><span class="p">,</span> <span class="n">meanfunc</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_dataclass</span><span class="p">(</span><span class="n">meanfunc</span><span class="p">)</span>
        <span class="n">a_dataclass</span><span class="p">,</span> <span class="n">anat</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_dataclass</span><span class="p">(</span><span class="n">anat</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;BiasFieldCorrection-</span><span class="si">{}</span><span class="s1"> &amp; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">meanfunc</span><span class="p">,</span> <span class="n">anat</span><span class="p">))</span>
        <span class="n">step01</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;BiasFieldCorrection-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
        <span class="n">step02</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;BiasFieldCorrection-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">anat</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-Subject: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">single_session</span><span class="p">:</span>
                <span class="n">epi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">f_dataclass</span><span class="p">,</span> <span class="n">meanfunc</span><span class="p">,</span> <span class="n">subj</span><span class="p">)</span>
                <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">a_dataclass</span><span class="p">,</span> <span class="n">anat</span><span class="p">,</span> <span class="n">subj</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">epi</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename of func: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;ants_BiasFieldCorrection&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span>
                                     <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;n4&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">t2</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename of anat: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;ants_BiasFieldCorrection&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span>
                                     <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;n4&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; :Session: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sess</span><span class="p">))</span>
                    <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">))</span>
                    <span class="n">epi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">f_dataclass</span><span class="p">,</span> <span class="n">meanfunc</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span>
                    <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">f_dataclass</span><span class="p">,</span> <span class="n">anat</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">epi</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  +Filename of func: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;ants_BiasFieldCorrection&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span>
                                         <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;n4&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">t2</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  +Filename of anat: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;ants_BiasFieldCorrection&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span>
                                         <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;n4&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Coregistration-</span><span class="si">{}</span><span class="s1"> to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">meanfunc</span><span class="p">,</span> <span class="n">anat</span><span class="p">))</span>
        <span class="n">step03</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;Coregistration-</span><span class="si">{}</span><span class="s1">2</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">anat</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">num_step</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">step03</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">step04</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_step</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_CheckRegistraton-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_step</span><span class="p">,</span> <span class="n">dtype</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">:</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step04</span><span class="p">,</span> <span class="s1">&#39;AllSubjects&#39;</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-Subject: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step03</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">single_session</span><span class="p">:</span>
                <span class="n">epi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">step01</span><span class="p">),</span> <span class="n">subj</span><span class="p">)</span>
                <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">step02</span><span class="p">),</span> <span class="n">subj</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">epi</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                    <span class="n">fixed_img</span> <span class="o">=</span> <span class="n">t2</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Abspath</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">moved_img</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step03</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dAllineate&#39;</span><span class="p">,</span> <span class="n">moved_img</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">onepass</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">EPI</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                     <span class="n">base</span><span class="o">=</span><span class="n">fixed_img</span><span class="p">,</span> <span class="n">cmass</span><span class="o">=</span><span class="s1">&#39;+xy&#39;</span><span class="p">,</span> <span class="n">matrix_save</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step03</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
                    <span class="n">fig1</span> <span class="o">=</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">check_reg</span><span class="p">(</span><span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">),</span>
                                            <span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">moved_img</span><span class="p">),</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="n">fig1</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;EPI to T2 for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">)</span>
                    <span class="n">fig1</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step04</span><span class="p">,</span> <span class="s1">&#39;AllSubjects&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">subj</span><span class="p">,</span> <span class="s1">&#39;func2anat&#39;</span><span class="p">]))),</span>
                                 <span class="n">facecolor</span><span class="o">=</span><span class="n">fig1</span><span class="o">.</span><span class="n">get_facecolor</span><span class="p">())</span>
                    <span class="n">fig2</span> <span class="o">=</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">check_reg</span><span class="p">(</span><span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">moved_img</span><span class="p">),</span>
                                            <span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">),</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="n">fig2</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;T2 to EPI for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">)</span>
                    <span class="n">fig2</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step04</span><span class="p">,</span> <span class="s1">&#39;AllSubjects&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">subj</span><span class="p">,</span> <span class="s1">&#39;anat2func&#39;</span><span class="p">]))),</span>
                                 <span class="n">facecolor</span><span class="o">=</span><span class="n">fig2</span><span class="o">.</span><span class="n">get_facecolor</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step04</span><span class="p">,</span> <span class="n">subj</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step04</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="s1">&#39;AllSessions&#39;</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; :Session: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sess</span><span class="p">))</span>
                    <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step03</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">))</span>
                    <span class="n">epi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">step01</span><span class="p">),</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span>
                    <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">step02</span><span class="p">),</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">epi</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  +Filename of anat: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                        <span class="n">fixed_img</span> <span class="o">=</span> <span class="n">t2</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Abspath</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">moved_img</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step03</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dAllineate&#39;</span><span class="p">,</span> <span class="n">moved_img</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">onepass</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">EPI</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                         <span class="n">base</span><span class="o">=</span><span class="n">fixed_img</span><span class="p">,</span> <span class="n">cmass</span><span class="o">=</span><span class="s1">&#39;+xy&#39;</span><span class="p">,</span>
                                         <span class="n">matrix_save</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step03</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">sess</span><span class="p">))</span>
                        <span class="n">fig1</span> <span class="o">=</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">check_reg</span><span class="p">(</span><span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">),</span>
                                                <span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">moved_img</span><span class="p">),</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                        <span class="n">fig1</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;EPI to T2 for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">)</span>
                        <span class="n">fig1</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step04</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="s1">&#39;AllSessions&#39;</span><span class="p">,</span>
                                                  <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">sess</span><span class="p">,</span> <span class="s1">&#39;func2anat&#39;</span><span class="p">]))),</span>
                                     <span class="n">facecolor</span><span class="o">=</span><span class="n">fig1</span><span class="o">.</span><span class="n">get_facecolor</span><span class="p">())</span>
                        <span class="n">fig2</span> <span class="o">=</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">check_reg</span><span class="p">(</span><span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">moved_img</span><span class="p">),</span>
                                                <span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">),</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                        <span class="n">fig2</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;T2 to EPI for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">)</span>
                        <span class="n">fig2</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step04</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="s1">&#39;AllSessions&#39;</span><span class="p">,</span>
                                                  <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">sess</span><span class="p">,</span> <span class="s1">&#39;anat2func&#39;</span><span class="p">]))),</span>
                                     <span class="n">facecolor</span><span class="o">=</span><span class="n">fig2</span><span class="o">.</span><span class="n">get_facecolor</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;meanfunc&#39;</span><span class="p">:</span> <span class="n">step01</span><span class="p">,</span> <span class="s1">&#39;anat&#39;</span><span class="p">:</span><span class="n">step02</span><span class="p">,</span> <span class="s1">&#39;realigned_func&#39;</span><span class="p">:</span> <span class="n">step03</span><span class="p">,</span> <span class="s1">&#39;checkreg&#39;</span><span class="p">:</span> <span class="n">step04</span><span class="p">}</span></div>

<div class="viewcode-block" id="Preprocess.apply_brainmask"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Preprocess.apply_brainmask">[docs]</a>    <span class="k">def</span> <span class="nf">apply_brainmask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">padded</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zaxis</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method for applying brain mark to individual 3d+t functional images</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func       : str</span>
<span class="sd">            Datatype or absolute step path of the input functional image</span>
<span class="sd">        mask       : str</span>
<span class="sd">            Absolute step path which contains the mask of the functional image</span>
<span class="sd">        padded     : bool</span>
<span class="sd">        zaxis      : int</span>
<span class="sd">        dtype      : str</span>
<span class="sd">            Surfix for the step path</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        step_paths : dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;z&#39;</span><span class="p">}</span>
        <span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_dataclass</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ApplyingBrainMask-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
        <span class="n">step01</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;ApplyingBrainMask-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-Subject: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">single_session</span><span class="p">:</span>
                <span class="n">epi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">)</span>
                <span class="n">epimask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="n">subj</span><span class="p">,</span> <span class="n">file_tag</span><span class="o">=</span><span class="s1">&#39;_mask&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span>
                <span class="n">maskobj</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">epimask</span><span class="o">.</span><span class="n">Abspath</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">padded</span><span class="p">:</span>
                    <span class="n">exec</span> <span class="p">(</span><span class="s1">&#39;maskobj.crop(</span><span class="si">{}</span><span class="s1">=[1, </span><span class="si">{}</span><span class="s1">])&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">axis</span><span class="p">[</span><span class="n">zaxis</span><span class="p">],</span> <span class="n">maskobj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">zaxis</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">temp_epimask</span> <span class="o">=</span> <span class="n">TempFile</span><span class="p">(</span><span class="n">maskobj</span><span class="p">,</span> <span class="s1">&#39;epimask_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">epi</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dcalc&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span> <span class="s1">&#39;a*step(b)&#39;</span><span class="p">,</span>
                                     <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">temp_epimask</span><span class="p">))</span>
                <span class="n">temp_epimask</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; :Session: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sess</span><span class="p">))</span>
                    <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">))</span>
                    <span class="n">epi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span>
                    <span class="n">epimask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">file_tag</span><span class="o">=</span><span class="s1">&#39;_mask&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span>
                    <span class="n">maskobj</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">epimask</span><span class="o">.</span><span class="n">Abspath</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">padded</span><span class="p">:</span>
                        <span class="n">exec</span> <span class="p">(</span><span class="s1">&#39;maskobj.crop(</span><span class="si">{}</span><span class="s1">=[1, </span><span class="si">{}</span><span class="s1">])&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">axis</span><span class="p">[</span><span class="n">zaxis</span><span class="p">],</span> <span class="n">maskobj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">zaxis</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">temp_epimask</span> <span class="o">=</span> <span class="n">TempFile</span><span class="p">(</span><span class="n">maskobj</span><span class="p">,</span> <span class="s1">&#39;epimask_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">epi</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dcalc&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span> <span class="s1">&#39;a*step(b)&#39;</span><span class="p">,</span>
                                         <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">temp_epimask</span><span class="p">))</span>
                    <span class="n">temp_epimask</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">step01</span><span class="p">}</span></div>

<div class="viewcode-block" id="Preprocess.apply_transformation"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Preprocess.apply_transformation">[docs]</a>    <span class="k">def</span> <span class="nf">apply_transformation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">realigned_func</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method for applying transformation matrix to individual 3d+t functional images</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func           : str</span>
<span class="sd">            Datatype or absolute step path for the input functional image</span>
<span class="sd">        realigned_func : str</span>
<span class="sd">            Absolute step path which contains the realigned functional image</span>
<span class="sd">        dtype          : str</span>
<span class="sd">            Surfix for the step path</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        step_paths     : dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_dataclass</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ApplyingTransformation-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
        <span class="n">step01</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;ApplyingTransformation-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-Subject: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">single_session</span><span class="p">:</span>
                <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">realigned_func</span><span class="p">),</span> <span class="n">subj</span><span class="p">)</span>
                <span class="n">param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">realigned_func</span><span class="p">),</span> <span class="n">subj</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;.1D&#39;</span><span class="p">)</span>
                <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">func</span><span class="p">),</span> <span class="n">subj</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                    <span class="n">moved_img</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dAllineate&#39;</span><span class="p">,</span> <span class="n">moved_img</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">master</span><span class="o">=</span><span class="n">ref</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Abspath</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                     <span class="n">matrix_apply</span><span class="o">=</span><span class="n">param</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Abspath</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; :Session: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sess</span><span class="p">))</span>
                    <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">))</span>
                    <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">realigned_func</span><span class="p">),</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span>
                    <span class="n">param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">realigned_func</span><span class="p">),</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;.1D&#39;</span><span class="p">)</span>
                    <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">func</span><span class="p">),</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                        <span class="n">moved_img</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dAllineate&#39;</span><span class="p">,</span> <span class="n">moved_img</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">master</span><span class="o">=</span><span class="n">ref</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Abspath</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                         <span class="n">matrix_apply</span><span class="o">=</span><span class="n">param</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Abspath</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">step01</span><span class="p">}</span></div>

<div class="viewcode-block" id="Preprocess.global_regression"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Preprocess.global_regression">[docs]</a>    <span class="k">def</span> <span class="nf">global_regression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method for global signal regression of individual functional image</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func       : str</span>
<span class="sd">            Datatype or absolute step path for the input functional image</span>
<span class="sd">        dtype      : str</span>
<span class="sd">            Surfix for the step path</span>
<span class="sd">        detrend    : int</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        step_paths : dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_dataclass</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;GlobalRegression-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
        <span class="n">step01</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;GlobalRegression-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-Subject: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">single_session</span><span class="p">:</span>
                <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                    <span class="n">regressor</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.1D&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dmaskave&#39;</span><span class="p">,</span> <span class="n">regressor</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dDetrend&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span>
                                     <span class="n">vector</span><span class="o">=</span><span class="n">regressor</span><span class="p">,</span> <span class="n">polort</span><span class="o">=</span><span class="s1">&#39;-1&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; :Session: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sess</span><span class="p">))</span>
                    <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">))</span>
                    <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                        <span class="n">regressor</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span>
                                                 <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.1D&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dmaskave&#39;</span><span class="p">,</span> <span class="n">regressor</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dDetrend&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span>
                                         <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">vector</span><span class="o">=</span><span class="n">regressor</span><span class="p">,</span> <span class="n">polort</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">detrend</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">step01</span><span class="p">}</span></div>

<div class="viewcode-block" id="Preprocess.motion_parameter_regression"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Preprocess.motion_parameter_regression">[docs]</a>    <span class="k">def</span> <span class="nf">motion_parameter_regression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">motioncorrected_func</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method for motion parameter regression of individual functional image</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func                 : str</span>
<span class="sd">            Datatype or absolute path of the input functional image</span>
<span class="sd">        motioncorrected_func : str</span>
<span class="sd">            Absolute step path which contains the motion corrected functional image</span>
<span class="sd">        dtype                : str</span>
<span class="sd">            Surfix for the step path</span>
<span class="sd">        detrend              : int</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        step_paths          : dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_dataclass</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MotionRegression-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
        <span class="n">step01</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;MotionRegression-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-Subject: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">single_session</span><span class="p">:</span>
                <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                    <span class="n">regressor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">motioncorrected_func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;.1D&#39;</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="s1">&#39;.aff12&#39;</span><span class="p">,</span>
                                             <span class="n">file_tag</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Abspath</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dDetrend&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span>
                                     <span class="n">vector</span><span class="o">=</span><span class="n">regressor</span><span class="p">,</span> <span class="n">polort</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">detrend</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; :Session: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sess</span><span class="p">))</span>
                    <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">))</span>
                    <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                        <span class="n">regressor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">motioncorrected_func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;.1D&#39;</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="s1">&#39;.aff12&#39;</span><span class="p">,</span>
                                                 <span class="n">file_tag</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Abspath</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dDetrend&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span>
                                         <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">vector</span><span class="o">=</span><span class="n">regressor</span><span class="p">,</span> <span class="n">polort</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">detrend</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">step01</span><span class="p">}</span></div>

<div class="viewcode-block" id="Preprocess.cbv_calculation"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Preprocess.cbv_calculation">[docs]</a>    <span class="k">def</span> <span class="nf">cbv_calculation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">meanBOLD</span><span class="p">,</span> <span class="n">mean_range</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func</span>
<span class="sd">        meanBOLD</span>
<span class="sd">        dtype</span>
<span class="sd">        kwargs</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_dataclass</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="n">mb_dataclass</span><span class="p">,</span> <span class="n">meanBOLD</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_dataclass</span><span class="p">(</span><span class="n">meanBOLD</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CBV_Calculation-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
        <span class="n">step01</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;CBV_Calculation-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-Subject: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">single_session</span><span class="p">:</span>
                <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">)</span>
                <span class="n">szero</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">mb_dataclass</span><span class="p">,</span> <span class="n">meanBOLD</span><span class="p">,</span> <span class="n">subj</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
                    <span class="n">imgobj</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">)</span>
                    <span class="n">imgobj</span><span class="o">.</span><span class="n">_dataobj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">imgobj</span><span class="o">.</span><span class="n">_dataobj</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">mean_range</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                    <span class="n">spre</span> <span class="o">=</span> <span class="n">TempFile</span><span class="p">(</span><span class="n">imgobj</span><span class="p">,</span> <span class="s1">&#39;spre_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dcalc&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span> <span class="s1">&#39;log(b/a)/log(c/b)&#39;</span><span class="p">,</span>
                                     <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">spre</span><span class="p">),</span> <span class="n">szero</span><span class="o">.</span><span class="n">Abspath</span><span class="p">)</span>
                    <span class="c1"># self._prjobj.run(&#39;afni_3dcalc&#39;, os.path.join(step01, subj, finfo.Filename), &#39;(b-a)/(c-b)*100&#39;,</span>
                    <span class="c1">#                  finfo.Abspath, str(spre), szero.Abspath)</span>
                    <span class="n">spre</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; :Session: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sess</span><span class="p">))</span>
                    <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">))</span>
                    <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span>
                    <span class="n">szero</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">mb_dataclass</span><span class="p">,</span> <span class="n">meanBOLD</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
                        <span class="n">imgobj</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">)</span>
                        <span class="n">imgobj</span><span class="o">.</span><span class="n">_dataobj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">imgobj</span><span class="o">.</span><span class="n">_dataobj</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">mean_range</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                        <span class="n">spre</span> <span class="o">=</span> <span class="n">TempFile</span><span class="p">(</span><span class="n">imgobj</span><span class="p">,</span> <span class="s1">&#39;spre_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">))</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dcalc&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span> <span class="s1">&#39;log(b/a)/log(c/b)&#39;</span><span class="p">,</span>
                                         <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">spre</span><span class="p">),</span> <span class="n">szero</span><span class="o">.</span><span class="n">Abspath</span><span class="p">)</span>
                        <span class="c1"># self._prjobj.run(&#39;afni_3dcalc&#39;, os.path.join(step01, subj, sess, finfo.Filename),</span>
                        <span class="c1">#                  &#39;(b-a)/(c-b)*100&#39;, finfo.Abspath, str(spre), szero.Abspath)</span>
                        <span class="n">spre</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;cbv&#39;</span><span class="p">:</span> <span class="n">step01</span><span class="p">}</span></div>

<div class="viewcode-block" id="Preprocess.check_cbv_correction"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Preprocess.check_cbv_correction">[docs]</a>    <span class="k">def</span> <span class="nf">check_cbv_correction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">meanBOLD</span><span class="p">,</span> <span class="n">meanCBV</span><span class="p">,</span> <span class="n">mean_range</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">echotime</span><span class="o">=</span><span class="mf">0.008</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func</span>
<span class="sd">        meanBOLD</span>
<span class="sd">        dtype</span>
<span class="sd">        kwargs</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_dataclass</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="n">mb_dataclass</span><span class="p">,</span> <span class="n">meanBOLD</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_dataclass</span><span class="p">(</span><span class="n">meanBOLD</span><span class="p">)</span>
        <span class="n">mc_dataclass</span><span class="p">,</span> <span class="n">meanCBV</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_dataclass</span><span class="p">(</span><span class="n">meanCBV</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CBV_Calculation-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
        <span class="n">step01</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;deltaR2forSTIM-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
        <span class="n">step02</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;deltaR2forMION-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
        <span class="n">step03</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;deltaR2forMIONcorrected-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-Subject: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step03</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">single_session</span><span class="p">:</span>
                <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">)</span>
                <span class="n">szero</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">mb_dataclass</span><span class="p">,</span> <span class="n">meanBOLD</span><span class="p">,</span> <span class="n">subj</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">smion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">mb_dataclass</span><span class="p">,</span> <span class="n">meanCBV</span><span class="p">,</span> <span class="n">subj</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
                    <span class="n">imgobj</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">)</span>
                    <span class="n">imgobj</span><span class="o">.</span><span class="n">_dataobj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">imgobj</span><span class="o">.</span><span class="n">_dataobj</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">mean_range</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                    <span class="n">spre</span> <span class="o">=</span> <span class="n">TempFile</span><span class="p">(</span><span class="n">imgobj</span><span class="p">,</span> <span class="s1">&#39;spre_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dcalc&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span>
                                     <span class="s1">&#39;(-1/</span><span class="si">{TE}</span><span class="s1">)*log(a/b)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">TE</span><span class="o">=</span><span class="n">echotime</span><span class="p">),</span>
                                     <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">spre</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dcalc&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span>
                                     <span class="s1">&#39;(-1/</span><span class="si">{TE}</span><span class="s1">)*log(a/b)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">TE</span><span class="o">=</span><span class="n">echotime</span><span class="p">),</span>
                                     <span class="n">smion</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">szero</span><span class="o">.</span><span class="n">Abspath</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dcalc&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step03</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span>
                                     <span class="s1">&#39;(-1/</span><span class="si">{TE}</span><span class="s1">)*log(a/b)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">TE</span><span class="o">=</span><span class="n">echotime</span><span class="p">),</span>
                                     <span class="nb">str</span><span class="p">(</span><span class="n">spre</span><span class="p">),</span> <span class="n">szero</span><span class="o">.</span><span class="n">Abspath</span><span class="p">)</span>
                    <span class="c1"># self._prjobj.run(&#39;afni_3dcalc&#39;, os.path.join(step01, subj, finfo.Filename), &#39;(b-a)/(c-b)*100&#39;,</span>
                    <span class="c1">#                  finfo.Abspath, str(spre), szero.Abspath)</span>
                    <span class="n">spre</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; :Session: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sess</span><span class="p">))</span>
                    <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">),</span>
                                  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step03</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">))</span>
                    <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span>
                    <span class="n">szero</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">mb_dataclass</span><span class="p">,</span> <span class="n">meanBOLD</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">smion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">mb_dataclass</span><span class="p">,</span> <span class="n">meanCBV</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
                        <span class="n">imgobj</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">)</span>
                        <span class="n">imgobj</span><span class="o">.</span><span class="n">_dataobj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">imgobj</span><span class="o">.</span><span class="n">_dataobj</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">mean_range</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                        <span class="n">spre</span> <span class="o">=</span> <span class="n">TempFile</span><span class="p">(</span><span class="n">imgobj</span><span class="p">,</span> <span class="s1">&#39;spre_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">))</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dcalc&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span>
                                         <span class="s1">&#39;(-1/</span><span class="si">{TE}</span><span class="s1">)*log(a/b)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">TE</span><span class="o">=</span><span class="n">echotime</span><span class="p">),</span>
                                         <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">spre</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dcalc&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span>
                                         <span class="s1">&#39;(-1/</span><span class="si">{TE}</span><span class="s1">)*log(a/b)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">TE</span><span class="o">=</span><span class="n">echotime</span><span class="p">),</span>
                                         <span class="n">smion</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">szero</span><span class="o">.</span><span class="n">Abspath</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dcalc&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span>
                                         <span class="s1">&#39;(-1/</span><span class="si">{TE}</span><span class="s1">)*log(a/b)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">TE</span><span class="o">=</span><span class="n">echotime</span><span class="p">),</span>
                                         <span class="nb">str</span><span class="p">(</span><span class="n">spre</span><span class="p">),</span> <span class="n">szero</span><span class="o">.</span><span class="n">Abspath</span><span class="p">)</span>
                        <span class="c1"># self._prjobj.run(&#39;afni_3dcalc&#39;, os.path.join(step01, subj, sess, finfo.Filename),</span>
                        <span class="c1">#                  &#39;(b-a)/(c-b)*100&#39;, finfo.Abspath, str(spre), szero.Abspath)</span>
                        <span class="n">spre</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;cbv&#39;</span><span class="p">:</span> <span class="n">step01</span><span class="p">}</span></div>

<div class="viewcode-block" id="Preprocess.spatial_smoothing"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Preprocess.spatial_smoothing">[docs]</a>    <span class="k">def</span> <span class="nf">spatial_smoothing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">FWHM</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func</span>
<span class="sd">        mask</span>
<span class="sd">        FWHM</span>
<span class="sd">        quiet</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_dataclass</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SpatialSmoothing-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
        <span class="n">step01</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;SpatialSmoothing-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-Subject: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">single_session</span><span class="p">:</span>
                <span class="n">epi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mask</span><span class="p">:</span>
                    <span class="n">epimask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="n">subj</span><span class="p">,</span> <span class="n">file_tag</span><span class="o">=</span><span class="s1">&#39;_mask&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">epimask</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">epi</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">mask</span><span class="p">:</span>
                        <span class="n">mask</span> <span class="o">=</span> <span class="n">epimask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">Abspath</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dBlurInMask&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span>
                                     <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">FWHM</span><span class="o">=</span><span class="n">FWHM</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="n">quiet</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; :Session: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sess</span><span class="p">))</span>
                    <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">))</span>
                    <span class="n">epi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">mask</span><span class="p">:</span>
                        <span class="n">epimask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">file_tag</span><span class="o">=</span><span class="s1">&#39;_mask&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">epimask</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">epi</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">mask</span><span class="p">:</span>
                            <span class="n">mask</span> <span class="o">=</span> <span class="n">epimask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">Abspath</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dBlurInMask&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span>
                                         <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">FWHM</span><span class="o">=</span><span class="n">FWHM</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="n">quiet</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">step01</span><span class="p">}</span></div>

<div class="viewcode-block" id="Preprocess.signal_processing"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Preprocess.signal_processing">[docs]</a>    <span class="k">def</span> <span class="nf">signal_processing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">despike</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">blur</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="n">file_tag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method for signal processing and spatial smoothing of individual functional image</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func        : str</span>
<span class="sd">            Datatype or Absolute step path for the input functional image</span>
<span class="sd">        dt          : int</span>
<span class="sd">        norm        : boolean</span>
<span class="sd">        despike     : boolean</span>
<span class="sd">        detrend     : int</span>
<span class="sd">        blur        : float</span>
<span class="sd">        band        : list of float</span>
<span class="sd">        dtype       : str</span>
<span class="sd">            Surfix for the step path</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        step_paths  : dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_dataclass</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SignalProcessing-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
        <span class="n">step01</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;SignalProcessing-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-Subject: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">single_session</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">file_tag</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore</span><span class="p">:</span>
                        <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="n">ignore</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore</span><span class="p">:</span>
                        <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">file_tag</span><span class="o">=</span><span class="n">file_tag</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">file_tag</span><span class="o">=</span><span class="n">file_tag</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="n">ignore</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dBandpass&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span>
                                     <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">despike</span><span class="o">=</span><span class="n">despike</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">blur</span><span class="o">=</span><span class="n">blur</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="n">band</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; :Session: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sess</span><span class="p">))</span>
                    <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_tag</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore</span><span class="p">:</span>
                            <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="n">ignore</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore</span><span class="p">:</span>
                            <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">file_tag</span><span class="o">=</span><span class="n">file_tag</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">file_tag</span><span class="o">=</span><span class="n">file_tag</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="n">ignore</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dBandpass&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span>
                                         <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">despike</span><span class="o">=</span><span class="n">despike</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">blur</span><span class="o">=</span><span class="n">blur</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="n">band</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">step01</span><span class="p">}</span></div>

<div class="viewcode-block" id="Preprocess.signal_processing2"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Preprocess.signal_processing2">[docs]</a>    <span class="k">def</span> <span class="nf">signal_processing2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ort</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">orange</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">blur</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; New method for signal processing and spatial smoothing of individual functional image</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func</span>
<span class="sd">        dt</span>
<span class="sd">        mask</span>
<span class="sd">        ort</span>
<span class="sd">        norm</span>
<span class="sd">        blur</span>
<span class="sd">        band</span>
<span class="sd">        dtype</span>
<span class="sd">        file_tag</span>
<span class="sd">        ignore</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_dataclass</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ort</span><span class="p">:</span>
            <span class="n">mdataclass</span><span class="p">,</span> <span class="n">ort</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_dataclass</span><span class="p">(</span><span class="n">ort</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SignalProcessing-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
        <span class="n">step01</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;SignalProcessing-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-Subject: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">single_session</span><span class="p">:</span>
                <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ort</span><span class="p">:</span>
                        <span class="n">regressor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">mdataclass</span><span class="p">,</span> <span class="n">ort</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;.1D&#39;</span><span class="p">,</span>
                                                 <span class="n">file_tag</span><span class="o">=</span><span class="n">methods</span><span class="o">.</span><span class="n">splitnifti</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span>
                                                 <span class="n">ignore</span><span class="o">=</span><span class="s1">&#39;.aff12&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Abspath</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">regressor</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dTproject&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span>
                                     <span class="n">ort</span><span class="o">=</span><span class="n">regressor</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">orange</span><span class="o">=</span><span class="n">orange</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">blur</span><span class="o">=</span><span class="n">blur</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="n">band</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; :Session: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sess</span><span class="p">))</span>
                    <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">))</span>
                    <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">ort</span><span class="p">:</span>
                            <span class="n">regressor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">mdataclass</span><span class="p">,</span> <span class="n">ort</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;.1D&#39;</span><span class="p">,</span>
                                                     <span class="n">file_tag</span><span class="o">=</span><span class="n">methods</span><span class="o">.</span><span class="n">splitnifti</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span>
                                                     <span class="n">ignore</span><span class="o">=</span><span class="s1">&#39;.aff12&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Abspath</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">regressor</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dTproject&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">),</span>
                                         <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">ort</span><span class="o">=</span><span class="n">regressor</span><span class="p">,</span> <span class="n">orange</span><span class="o">=</span><span class="n">orange</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span>
                                         <span class="n">blur</span><span class="o">=</span><span class="n">blur</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="n">band</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">step01</span><span class="p">}</span></div>

<div class="viewcode-block" id="Preprocess.warp_func"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Preprocess.warp_func">[docs]</a>    <span class="k">def</span> <span class="nf">warp_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">warped_anat</span><span class="p">,</span> <span class="n">tempobj</span><span class="p">,</span> <span class="n">atlas</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method for warping the individual functional image to template space</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func        : str</span>
<span class="sd">            Datatype or Absolute step path for the input functional image</span>
<span class="sd">        warped_anat : str</span>
<span class="sd">            Absolute step path which contains diffeomorphic map and transformation matrix</span>
<span class="sd">            which is generated by the methods of &#39;pynit.Preprocessing.warp_anat_to_template&#39;</span>
<span class="sd">        tempobj     : pynit.Template</span>
<span class="sd">            The template object which contains set of atlas</span>
<span class="sd">        dtype       : str</span>
<span class="sd">            Surfix for the step path</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        step_paths  : dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check the source of input data</span>
        <span class="n">in_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;atlas&#39;</span><span class="p">:</span> <span class="n">atlas</span><span class="p">}</span>
        <span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_dataclass</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warp-</span><span class="si">{}</span><span class="s2"> to Atlas and Check it&#39;s registration&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
        <span class="n">step01</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;Warp-</span><span class="si">{}</span><span class="s1">2atlas&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
        <span class="n">num_step</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">step01</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">step02</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_step</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_CheckAtlasRegistration-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_step</span><span class="p">,</span> <span class="n">dtype</span><span class="p">))</span>
        <span class="c1"># Loop the subjects</span>
        <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-Subject: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">single_session</span><span class="p">:</span>
                <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="s1">&#39;AllSubjects&#39;</span><span class="p">))</span>
                <span class="c1"># Grab the warping map and transform matrix</span>
                <span class="n">mats</span><span class="p">,</span> <span class="n">warps</span><span class="p">,</span> <span class="n">warped</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">get_warp_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">warped_anat</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="c1"># temp_path = os.path.join(step01, subj, &quot;base&quot;)</span>
                <span class="c1"># tempobj.save_as(temp_path, quiet=True)</span>
                <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename of fixed image: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">warped</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename of moving image: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                    <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;ants_WarpTimeSeriresImageMultiTransform&#39;</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span>
                                     <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">warped</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">warps</span><span class="p">,</span> <span class="n">mats</span><span class="p">,</span> <span class="o">**</span><span class="n">in_kwargs</span><span class="p">)</span>
                <span class="n">subjatlas</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">load_temp</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">tempobj</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">subjatlas</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
                    <span class="n">fig</span> <span class="o">=</span> <span class="n">fig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Check atlas registration of </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="s1">&#39;AllSubjects&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">subj</span><span class="p">,</span> <span class="s1">&#39;checkatlas&#39;</span><span class="p">]))),</span>
                            <span class="n">facecolor</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">get_facecolor</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
                    <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="s1">&#39;AllSessions&#39;</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; :Session: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sess</span><span class="p">))</span>
                    <span class="c1"># Grab the warping map and transform matrix</span>
                    <span class="n">mats</span><span class="p">,</span> <span class="n">warps</span><span class="p">,</span> <span class="n">warped</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">get_warp_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">warped_anat</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="c1"># temp_path = os.path.join(step01, subj, sess, &quot;base&quot;)</span>
                    <span class="c1"># tempobj.save_as(temp_path, quiet=True)</span>
                    <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename of fixed image: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">warped</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename of moving image: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                        <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;ants_WarpTimeSeriesImageMultiTransform&#39;</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span>
                                         <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">warped</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">warps</span><span class="p">,</span> <span class="n">mats</span><span class="p">,</span> <span class="o">**</span><span class="n">in_kwargs</span><span class="p">)</span>
                    <span class="n">subjatlas</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">load_temp</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">tempobj</span><span class="o">.</span><span class="n">_atlas</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                    <span class="n">fig</span> <span class="o">=</span> <span class="n">subjatlas</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
                        <span class="n">fig</span> <span class="o">=</span> <span class="n">fig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Check atlas registration of </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">)</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="s1">&#39;AllSessions&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="s1">&#39;checkatlas&#39;</span><span class="p">]))),</span>
                                <span class="n">facecolor</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">get_facecolor</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">step01</span><span class="p">,</span> <span class="s1">&#39;checkreg&#39;</span><span class="p">:</span> <span class="n">step02</span><span class="p">}</span></div>

<div class="viewcode-block" id="Preprocess.linear_spatial_normalization"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Preprocess.linear_spatial_normalization">[docs]</a>    <span class="k">def</span> <span class="nf">linear_spatial_normalization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">anat</span><span class="p">,</span> <span class="n">tempobj</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;anat&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        anat</span>
<span class="sd">        tempobj</span>
<span class="sd">        dtype</span>
<span class="sd">        kwargs</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check the source of input data</span>
        <span class="n">dataclass</span><span class="p">,</span> <span class="n">anat</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_dataclass</span><span class="p">(</span><span class="n">anat</span><span class="p">)</span>
        <span class="c1"># Print step ans initiate the step</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SpatialNormalization-</span><span class="si">{}</span><span class="s1"> to Tempalte&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">anat</span><span class="p">))</span>
        <span class="n">step01</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;SpatialNormalization-</span><span class="si">{}</span><span class="s1">2temp&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
        <span class="n">num_step</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">step01</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">step02</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_step</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_CheckRegistraton-</span><span class="si">{}</span><span class="s1">2Temp&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_step</span><span class="p">,</span> <span class="n">dtype</span><span class="p">))</span>
        <span class="c1"># Loop the subjects</span>
        <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-Subject: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">single_session</span><span class="p">:</span>
                <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="s1">&#39;AllSubjects&#39;</span><span class="p">))</span>
                <span class="n">anats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">anat</span><span class="p">,</span> <span class="n">subj</span><span class="p">)</span>
                <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">anats</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                    <span class="n">fixed_img</span> <span class="o">=</span> <span class="n">tempobj</span><span class="o">.</span><span class="n">template_path</span>
                    <span class="n">moved_img</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">)</span>
                    <span class="n">trans_mat</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">splitnifti</span><span class="p">(</span><span class="n">moved_img</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.aff12.1D&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dAllineate&#39;</span><span class="p">,</span> <span class="n">moved_img</span><span class="p">,</span>
                                     <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="n">fixed_img</span><span class="p">,</span> <span class="n">twopass</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmass</span><span class="o">=</span><span class="s1">&#39;xy&#39;</span><span class="p">,</span>
                                     <span class="n">zclip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">conv</span><span class="o">=</span><span class="s1">&#39;0.01&#39;</span><span class="p">,</span> <span class="n">cost</span><span class="o">=</span><span class="s1">&#39;crM&#39;</span><span class="p">,</span> <span class="n">ckeck</span><span class="o">=</span><span class="s1">&#39;nmi&#39;</span><span class="p">,</span> <span class="n">warp</span><span class="o">=</span><span class="s1">&#39;shr&#39;</span><span class="p">,</span>
                                     <span class="n">matrix_save</span><span class="o">=</span><span class="n">trans_mat</span><span class="p">)</span>
                    <span class="n">fig1</span> <span class="o">=</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">check_reg</span><span class="p">(</span><span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">),</span>
                                            <span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">moved_img</span><span class="p">),</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="n">fig1</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;T2 to Temp for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">)</span>
                    <span class="n">fig1</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="s1">&#39;AllSubjects&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">subj</span><span class="p">,</span> <span class="s1">&#39;anat2temp&#39;</span><span class="p">]))),</span>
                                 <span class="n">facecolor</span><span class="o">=</span><span class="n">fig1</span><span class="o">.</span><span class="n">get_facecolor</span><span class="p">())</span>
                    <span class="n">fig2</span> <span class="o">=</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">check_reg</span><span class="p">(</span><span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">moved_img</span><span class="p">),</span>
                                            <span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">),</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="n">fig2</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Temp to T2 for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">)</span>
                    <span class="n">fig2</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="s1">&#39;AllSubjects&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">subj</span><span class="p">,</span> <span class="s1">&#39;temp2anat&#39;</span><span class="p">]))),</span>
                                 <span class="n">facecolor</span><span class="o">=</span><span class="n">fig2</span><span class="o">.</span><span class="n">get_facecolor</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="s1">&#39;AllSessions&#39;</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; :Session: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sess</span><span class="p">))</span>
                    <span class="n">anats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">anat</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span>
                    <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">))</span>
                    <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="s1">&#39;AllSessions&#39;</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">anats</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                        <span class="n">fixed_img</span> <span class="o">=</span> <span class="n">tempobj</span><span class="o">.</span><span class="n">template_path</span>
                        <span class="n">moved_img</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">)</span>
                        <span class="n">trans_mat</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">splitnifti</span><span class="p">(</span><span class="n">moved_img</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.aff12.1D&#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dAllineate&#39;</span><span class="p">,</span> <span class="n">moved_img</span><span class="p">,</span>
                                         <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="n">fixed_img</span><span class="p">,</span> <span class="n">twopass</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmass</span><span class="o">=</span><span class="s1">&#39;xy&#39;</span><span class="p">,</span>
                                         <span class="n">zclip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">conv</span><span class="o">=</span><span class="s1">&#39;0.01&#39;</span><span class="p">,</span> <span class="n">cost</span><span class="o">=</span><span class="s1">&#39;crM&#39;</span><span class="p">,</span> <span class="n">ckeck</span><span class="o">=</span><span class="s1">&#39;nmi&#39;</span><span class="p">,</span> <span class="n">warp</span><span class="o">=</span><span class="s1">&#39;shr&#39;</span><span class="p">,</span>
                                         <span class="n">matrix_save</span><span class="o">=</span><span class="n">trans_mat</span><span class="p">)</span>
                        <span class="n">fig1</span> <span class="o">=</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">check_reg</span><span class="p">(</span><span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">),</span>
                                                <span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">moved_img</span><span class="p">),</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                        <span class="n">fig1</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;T2 to Temp for </span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">)</span>
                        <span class="n">fig1</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="s1">&#39;AllSessions&#39;</span><span class="p">,</span>
                                         <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="s1">&#39;anat2temp&#39;</span><span class="p">]))),</span>
                            <span class="n">facecolor</span><span class="o">=</span><span class="n">fig1</span><span class="o">.</span><span class="n">get_facecolor</span><span class="p">())</span>
                        <span class="n">fig2</span> <span class="o">=</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">check_reg</span><span class="p">(</span><span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">moved_img</span><span class="p">),</span>
                                                <span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fixed_img</span><span class="p">),</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                        <span class="n">fig2</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Temp to T2 for </span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">)</span>
                        <span class="n">fig2</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="s1">&#39;AllSessions&#39;</span><span class="p">,</span>
                                         <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="s1">&#39;temp2anat&#39;</span><span class="p">]))),</span>
                            <span class="n">facecolor</span><span class="o">=</span><span class="n">fig2</span><span class="o">.</span><span class="n">get_facecolor</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;norm_anat&#39;</span><span class="p">:</span> <span class="n">step01</span><span class="p">,</span> <span class="s1">&#39;checkreg&#39;</span><span class="p">:</span> <span class="n">step02</span><span class="p">}</span></div>

<div class="viewcode-block" id="Preprocess.apply_spatial_normalization"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Preprocess.apply_spatial_normalization">[docs]</a>    <span class="k">def</span> <span class="nf">apply_spatial_normalization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">norm_anat</span><span class="p">,</span> <span class="n">tempobj</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func</span>
<span class="sd">        norm_anat</span>
<span class="sd">        dtype</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_dataclass</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ApplyingSpatialNormalization-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
        <span class="n">step01</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;ApplyingSpatialNormalization-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
        <span class="n">num_step</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">step01</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">step02</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_step</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_CheckAtlasRegistration-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_step</span><span class="p">,</span> <span class="n">dtype</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-Subject: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">),</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="s1">&#39;AllSubjects&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">single_session</span><span class="p">:</span>
                <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">norm_anat</span><span class="p">),</span> <span class="n">subj</span><span class="p">)</span>
                <span class="n">param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">norm_anat</span><span class="p">),</span> <span class="n">subj</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;.1D&#39;</span><span class="p">)</span>
                <span class="n">temp_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="s2">&quot;base&quot;</span><span class="p">)</span>
                <span class="n">tempobj</span><span class="o">.</span><span class="n">save_as</span><span class="p">(</span><span class="n">temp_path</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">func</span><span class="p">),</span> <span class="n">subj</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                    <span class="n">moved_img</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dAllineate&#39;</span><span class="p">,</span> <span class="n">moved_img</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">master</span><span class="o">=</span><span class="n">ref</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Abspath</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                     <span class="n">matrix_apply</span><span class="o">=</span><span class="n">param</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Abspath</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">warp</span><span class="o">=</span><span class="s1">&#39;shr&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">subjatlas</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">load_temp</span><span class="p">(</span><span class="n">moved_img</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_atlas.nii&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">temp_path</span><span class="p">))</span>
                    <span class="n">fig</span> <span class="o">=</span> <span class="n">subjatlas</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
                        <span class="n">fig</span> <span class="o">=</span> <span class="n">fig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Check atlas registration of </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">)</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="s1">&#39;AllSubjects&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">subj</span><span class="p">,</span> <span class="s1">&#39;checkatlas&#39;</span><span class="p">]))),</span>
                        <span class="n">facecolor</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">get_facecolor</span><span class="p">())</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_atlas.nii&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">temp_path</span><span class="p">))</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_atlas.label&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">temp_path</span><span class="p">))</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_template.nii&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">temp_path</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; :Session: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sess</span><span class="p">))</span>
                    <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">),</span>
                                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">),</span>
                                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="s1">&#39;AllSessions&#39;</span><span class="p">))</span>
                    <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">norm_anat</span><span class="p">),</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span>
                    <span class="n">param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">norm_anat</span><span class="p">),</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;.1D&#39;</span><span class="p">)</span>
                    <span class="n">temp_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="s2">&quot;base&quot;</span><span class="p">)</span>
                    <span class="n">tempobj</span><span class="o">.</span><span class="n">save_as</span><span class="p">(</span><span class="n">temp_path</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">func</span><span class="p">),</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                        <span class="n">moved_img</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;afni_3dAllineate&#39;</span><span class="p">,</span> <span class="n">moved_img</span><span class="p">,</span> <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">master</span><span class="o">=</span><span class="n">ref</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Abspath</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                         <span class="n">matrix_apply</span><span class="o">=</span><span class="n">param</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Abspath</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">warp</span><span class="o">=</span><span class="s1">&#39;shr&#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">subjatlas</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">load_temp</span><span class="p">(</span><span class="n">moved_img</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_atlas.nii&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">temp_path</span><span class="p">))</span>
                        <span class="n">fig</span> <span class="o">=</span> <span class="n">subjatlas</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
                            <span class="n">fig</span> <span class="o">=</span> <span class="n">fig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Check atlas registration of </span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">)</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="s1">&#39;AllSessions&#39;</span><span class="p">,</span>
                                         <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="s1">&#39;checkatlas&#39;</span><span class="p">]))),</span>
                            <span class="n">facecolor</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">get_facecolor</span><span class="p">())</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_atlas.nii&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">temp_path</span><span class="p">))</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_atlas.label&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">temp_path</span><span class="p">))</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_template.nii&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">temp_path</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">step01</span><span class="p">}</span></div>

<div class="viewcode-block" id="Preprocess.warp_anat_to_template"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Preprocess.warp_anat_to_template">[docs]</a>    <span class="k">def</span> <span class="nf">warp_anat_to_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">anat</span><span class="p">,</span> <span class="n">tempobj</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;anat&#39;</span><span class="p">,</span> <span class="n">ttype</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="c1"># TODO: This code not work if the template image resolution is different with T2 image</span>
        <span class="sd">&quot;&quot;&quot; Method for warping the individual anatomical image to template</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        anat        : str</span>
<span class="sd">            Datatype or Absolute step path for the input anatomical image</span>
<span class="sd">        tempobj     : pynit.Template</span>
<span class="sd">            The template object which contains set of atlas</span>
<span class="sd">        dtype       : str</span>
<span class="sd">            Surfix for the step path</span>

<span class="sd">        ttype       : str</span>
<span class="sd">            Type of transformation</span>
<span class="sd">            &#39;s&#39; : Warping</span>
<span class="sd">            &#39;a&#39; : Affine</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        step_paths  : dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check the source of input data</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">anat</span><span class="p">):</span>
            <span class="n">dataclass</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">anat</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">path_splitter</span><span class="p">(</span><span class="n">anat</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dataclass</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Print step ans initiate the step</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warp-</span><span class="si">{}</span><span class="s1"> to Tempalte&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">anat</span><span class="p">))</span>
        <span class="n">step01</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;Warp-</span><span class="si">{}</span><span class="s1">2temp&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
        <span class="n">num_step</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">step01</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">step02</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_step</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_CheckRegistraton-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_step</span><span class="p">,</span> <span class="n">dtype</span><span class="p">))</span>
        <span class="c1"># Loop the subjects</span>
        <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-Subject: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">single_session</span><span class="p">:</span>
                <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="s1">&#39;AllSubjects&#39;</span><span class="p">))</span>
                <span class="n">anats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">anat</span><span class="p">,</span> <span class="n">subj</span><span class="p">)</span>
                <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">anats</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                    <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;ants_RegistrationSyn&#39;</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span>
                                     <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">base_path</span><span class="o">=</span><span class="n">tempobj</span><span class="o">.</span><span class="n">template_path</span><span class="p">,</span> <span class="n">quick</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ttype</span><span class="o">=</span><span class="n">ttype</span><span class="p">)</span>
                    <span class="n">fig1</span> <span class="o">=</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">check_reg</span><span class="p">(</span><span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">tempobj</span><span class="o">.</span><span class="n">template_path</span><span class="p">),</span>
                                            <span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_Warped.nii.gz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_path</span><span class="p">)),</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="n">fig1</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;T2 to Atlas for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">)</span>
                    <span class="n">fig1</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="s1">&#39;AllSubjects&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">subj</span><span class="p">,</span> <span class="s1">&#39;anat2temp&#39;</span><span class="p">]))),</span>
                                 <span class="n">facecolor</span><span class="o">=</span><span class="n">fig1</span><span class="o">.</span><span class="n">get_facecolor</span><span class="p">())</span>
                    <span class="n">fig2</span> <span class="o">=</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">check_reg</span><span class="p">(</span><span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_Warped.nii.gz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_path</span><span class="p">)),</span>
                                            <span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">tempobj</span><span class="o">.</span><span class="n">template_path</span><span class="p">),</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="n">fig2</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Atlas to T2 for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">)</span>
                    <span class="n">fig2</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="s1">&#39;AllSubjects&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">subj</span><span class="p">,</span> <span class="s1">&#39;temp2anat&#39;</span><span class="p">]))),</span>
                                 <span class="n">facecolor</span><span class="o">=</span><span class="n">fig2</span><span class="o">.</span><span class="n">get_facecolor</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="s1">&#39;AllSessions&#39;</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; :Session: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sess</span><span class="p">))</span>
                    <span class="n">anats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">anat</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span>
                    <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">anats</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                        <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;ants_RegistrationSyn&#39;</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span>
                                         <span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">base_path</span><span class="o">=</span><span class="n">tempobj</span><span class="o">.</span><span class="n">template_path</span><span class="p">,</span> <span class="n">quick</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ttype</span><span class="o">=</span><span class="n">ttype</span><span class="p">)</span>
                        <span class="n">fig1</span> <span class="o">=</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">check_reg</span><span class="p">(</span><span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">tempobj</span><span class="o">.</span><span class="n">template_path</span><span class="p">),</span>
                                                <span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_Warped.nii.gz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_path</span><span class="p">)),</span>
                                                <span class="n">sigma</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                        <span class="n">fig1</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;T2 to Atlas for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">)</span>
                        <span class="n">fig1</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="s1">&#39;AllSessions&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">subj</span><span class="p">,</span> <span class="s1">&#39;anat2temp&#39;</span><span class="p">]))),</span>
                            <span class="n">facecolor</span><span class="o">=</span><span class="n">fig1</span><span class="o">.</span><span class="n">get_facecolor</span><span class="p">())</span>
                        <span class="n">fig2</span> <span class="o">=</span> <span class="n">Viewer</span><span class="o">.</span><span class="n">check_reg</span><span class="p">(</span><span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_Warped.nii.gz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_path</span><span class="p">)),</span>
                                                <span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">tempobj</span><span class="o">.</span><span class="n">template_path</span><span class="p">),</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                        <span class="n">fig2</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Atlas to T2 for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">)</span>
                        <span class="n">fig2</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="s1">&#39;AllSessions&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">subj</span><span class="p">,</span> <span class="s1">&#39;temp2anat&#39;</span><span class="p">]))),</span>
                            <span class="n">facecolor</span><span class="o">=</span><span class="n">fig2</span><span class="o">.</span><span class="n">get_facecolor</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;warped_anat&#39;</span><span class="p">:</span> <span class="n">step01</span><span class="p">,</span> <span class="s1">&#39;checkreg&#39;</span><span class="p">:</span> <span class="n">step02</span><span class="p">}</span></div>

<div class="viewcode-block" id="Preprocess.warp_atlas_to_anat"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Preprocess.warp_atlas_to_anat">[docs]</a>    <span class="k">def</span> <span class="nf">warp_atlas_to_anat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">anat</span><span class="p">,</span> <span class="n">warped_anat</span><span class="p">,</span> <span class="n">tempobj</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;anat&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method for warping the atlas to individual anatomical image space</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        anat        : str</span>
<span class="sd">            Datatype or Absolute step path for the input anatomical image</span>
<span class="sd">        warped_anat : str</span>
<span class="sd">            Absolute step path which contains diffeomorphic map and transformation matrix</span>
<span class="sd">            which is generated by the methods of &#39;pynit.Preprocessing.warp_anat_to_template&#39;</span>
<span class="sd">        tempobj     : pynit.Template</span>
<span class="sd">            The template object which contains set of atlas</span>
<span class="sd">        dtype       : str</span>
<span class="sd">            Surfix for the step path</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        step_paths  : dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dataclass</span><span class="p">,</span> <span class="n">anat</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_dataclass</span><span class="p">(</span><span class="n">anat</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warp-Atlas to </span><span class="si">{}</span><span class="s2"> and Check it&#39;s registration&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">anat</span><span class="p">))</span>
        <span class="n">step01</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;Warp-atlas2</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
        <span class="n">num_step</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">step01</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">step02</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_step</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_CheckAtlasRegistration-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_step</span><span class="p">,</span> <span class="n">dtype</span><span class="p">))</span>
        <span class="c1"># Loop the subjects</span>
        <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-Subject: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">single_session</span><span class="p">:</span>
                <span class="c1"># Grab the warping map and transform matrix</span>
                <span class="n">mats</span><span class="p">,</span> <span class="n">warps</span><span class="p">,</span> <span class="n">warped</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">get_warp_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">warped_anat</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">temp_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">warped_anat</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="s2">&quot;base&quot;</span><span class="p">)</span>
                <span class="n">tempobj</span><span class="o">.</span><span class="n">save_as</span><span class="p">(</span><span class="n">temp_path</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">anats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">anat</span><span class="p">,</span> <span class="n">subj</span><span class="p">)</span>
                <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_atlas.nii&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
                <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="s1">&#39;AllSubjects&#39;</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">warped</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;ants_WarpImageMultiTransform&#39;</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span>
                                 <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_atlas.nii&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">temp_path</span><span class="p">),</span> <span class="n">warped</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span>
                                 <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="n">mats</span><span class="p">,</span> <span class="n">warps</span><span class="p">)</span>
                <span class="n">tempobj</span><span class="o">.</span><span class="n">atlasobj</span><span class="o">.</span><span class="n">save_as</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_atlas&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">)),</span> <span class="n">label_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">anats</span><span class="p">:</span>
                    <span class="n">subjatlas</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">load_temp</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">output_path</span><span class="p">)</span>
                    <span class="n">fig</span> <span class="o">=</span> <span class="n">subjatlas</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
                        <span class="n">fig</span> <span class="o">=</span> <span class="n">fig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Check atlas registration of </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">)</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">subj</span><span class="p">,</span> <span class="s1">&#39;checkatlas&#39;</span><span class="p">]))),</span>
                                <span class="n">facecolor</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">get_facecolor</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; :Session: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sess</span><span class="p">))</span>
                    <span class="c1"># Grab the warping map and transform matrix</span>
                    <span class="n">mats</span><span class="p">,</span> <span class="n">warps</span><span class="p">,</span> <span class="n">warped</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">get_warp_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">warped_anat</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">temp_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="s2">&quot;base&quot;</span><span class="p">)</span>
                    <span class="n">tempobj</span><span class="o">.</span><span class="n">save_as</span><span class="p">(</span><span class="n">temp_path</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">anats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">anat</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span>
                    <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_atlas.nii&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sess</span><span class="p">))</span>
                    <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="s1">&#39;AllSessoions&#39;</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">warped</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;ants_WarpImageMultiTransform&#39;</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span>
                                     <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_atlas.nii&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">temp_path</span><span class="p">),</span> <span class="n">warped</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="n">mats</span><span class="p">,</span> <span class="n">warps</span><span class="p">)</span>
                    <span class="n">tempobj</span><span class="o">.</span><span class="n">atlasobj</span><span class="o">.</span><span class="n">save_as</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_atlas&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sess</span><span class="p">)),</span> <span class="n">label_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">anats</span><span class="p">:</span>
                        <span class="n">subjatlas</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">load_temp</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">,</span> <span class="n">output_path</span><span class="p">)</span>
                        <span class="n">fig</span> <span class="o">=</span> <span class="n">subjatlas</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
                            <span class="n">fig</span> <span class="o">=</span> <span class="n">fig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Check atlas registration of </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sess</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">)</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="s1">&#39;AllSessions&#39;</span><span class="p">,</span>
                                                 <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">sess</span><span class="p">,</span> <span class="s1">&#39;checkatlas&#39;</span><span class="p">]))),</span>
                                    <span class="n">facecolor</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">get_facecolor</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;atlas&#39;</span><span class="p">:</span> <span class="n">step01</span><span class="p">,</span> <span class="s1">&#39;checkreg&#39;</span><span class="p">:</span> <span class="n">step02</span><span class="p">}</span></div>

<div class="viewcode-block" id="Preprocess.get_timetrace"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Preprocess.get_timetrace">[docs]</a>    <span class="k">def</span> <span class="nf">get_timetrace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">atlas</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="n">file_tag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subjects</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method for extracting timecourse from mask</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func       : str</span>
<span class="sd">            Datatype or absolute path of the input mean functional image</span>
<span class="sd">        atlas      : str</span>
<span class="sd">            template object which has atlas, or folder name which includes all mask</span>
<span class="sd">        dtype      : str</span>
<span class="sd">            Surfix for the step path</span>
<span class="sd">        kwargs     :</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        step_paths : dict</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">subjects</span><span class="p">:</span> <span class="c1">#TODO: Subject selection testcode, need to apply for all steps</span>
            <span class="n">subjects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">[:]</span>
        <span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_dataclass</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="n">atlas</span><span class="p">,</span> <span class="n">tempobj</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_atals_datatype</span><span class="p">(</span><span class="n">atlas</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ExtractTimeCourseData-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
        <span class="n">step01</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;ExtractTimeCourse-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-Subject: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">single_session</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">tempobj</span><span class="p">:</span>
                    <span class="c1"># atlas = self._prjobj(1, self._pipeline, atlas, subj).df.Abspath.loc[0]</span>
                    <span class="n">warped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">file_tag</span><span class="o">=</span><span class="s1">&#39;_InverseWarped&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Abspath</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">tempobj</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">load_temp</span><span class="p">(</span><span class="n">warped</span><span class="p">,</span> <span class="n">atlas</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">file_tag</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore</span><span class="p">:</span>
                        <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="n">ignore</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore</span><span class="p">:</span>
                        <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">file_tag</span><span class="o">=</span><span class="n">file_tag</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">file_tag</span><span class="o">=</span><span class="n">file_tag</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="n">ignore</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">Analysis</span><span class="o">.</span><span class="n">get_timetrace</span><span class="p">(</span><span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">),</span> <span class="n">tempobj</span><span class="p">,</span> <span class="n">afni</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.xlsx&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">])))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; :Session: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sess</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">tempobj</span><span class="p">:</span>
                        <span class="c1"># atlas = self._prjobj(1, self._pipeline, atlas, subj, sess).df.Abspath.loc[0]</span>
                        <span class="n">warped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span>
                                              <span class="n">file_tag</span><span class="o">=</span><span class="s1">&#39;_InverseWarped&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Abspath</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">tempobj</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">load_temp</span><span class="p">(</span><span class="n">warped</span><span class="p">,</span> <span class="n">atlas</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_tag</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore</span><span class="p">:</span>
                            <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="n">ignore</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore</span><span class="p">:</span>
                            <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">file_tag</span><span class="o">=</span><span class="n">file_tag</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">file_tag</span><span class="o">=</span><span class="n">file_tag</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="n">ignore</span><span class="p">)</span>
                    <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="n">Analysis</span><span class="o">.</span><span class="n">get_timetrace</span><span class="p">(</span><span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">),</span> <span class="n">tempobj</span><span class="p">,</span> <span class="n">afni</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                        <span class="n">df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.xlsx&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">])))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;timecourse&#39;</span><span class="p">:</span> <span class="n">step01</span><span class="p">}</span></div>

<div class="viewcode-block" id="Preprocess.get_correlation_matrix"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Preprocess.get_correlation_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">get_correlation_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">atlas</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="n">file_tag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subjects</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method for extracting timecourse, correlation matrix and calculating z-score matrix</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func       : str</span>
<span class="sd">            Datatype or absolute path of the input mean functional image</span>
<span class="sd">        atlas      : str</span>
<span class="sd">        dtype      : str</span>
<span class="sd">            Surfix for the step path</span>
<span class="sd">        kwargs     :</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        step_paths : dict</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">subjects</span><span class="p">:</span> <span class="c1">#TODO: Subject selection testcode, need to apply for all steps</span>
            <span class="n">subjects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">[:]</span>
        <span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_dataclass</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="n">atlas</span><span class="p">,</span> <span class="n">tempobj</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">check_atals_datatype</span><span class="p">(</span><span class="n">atlas</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ExtractTimeCourseData-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
        <span class="n">step01</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;ExtractTimeCourse-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
        <span class="n">step02</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_step</span><span class="p">(</span><span class="s1">&#39;CC_Matrix-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
        <span class="n">num_step</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">step02</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">step03</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_step</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_Zscore_Matrix-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_step</span><span class="p">,</span> <span class="n">dtype</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-Subject: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subj</span><span class="p">))</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step03</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">single_session</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">tempobj</span><span class="p">:</span>
                    <span class="c1"># atlas = self._prjobj(1, self._pipeline, atlas, subj).df.Abspath.loc[0]</span>
                    <span class="n">warped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">file_tag</span><span class="o">=</span><span class="s1">&#39;_InverseWarped&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Abspath</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">tempobj</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">load_temp</span><span class="p">(</span><span class="n">warped</span><span class="p">,</span> <span class="n">atlas</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">file_tag</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore</span><span class="p">:</span>
                        <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="n">ignore</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore</span><span class="p">:</span>
                        <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">file_tag</span><span class="o">=</span><span class="n">file_tag</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">file_tag</span><span class="o">=</span><span class="n">file_tag</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="n">ignore</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">Analysis</span><span class="o">.</span><span class="n">get_timetrace</span><span class="p">(</span><span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">),</span> <span class="n">tempobj</span><span class="p">,</span> <span class="n">afni</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.xlsx&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">])))</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.xlsx&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">])))</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">arctanh</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">corr</span><span class="p">())</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step03</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.xlsx&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">),</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step03</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; :Session: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sess</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">tempobj</span><span class="p">:</span>
                        <span class="c1"># atlas = self._prjobj(1, self._pipeline, atlas, subj, sess).df.Abspath.loc[0]</span>
                        <span class="n">warped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span>
                                              <span class="n">file_tag</span><span class="o">=</span><span class="s1">&#39;_InverseWarped&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Abspath</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">tempobj</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="n">load_temp</span><span class="p">(</span><span class="n">warped</span><span class="p">,</span> <span class="n">atlas</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_tag</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore</span><span class="p">:</span>
                            <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="n">ignore</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore</span><span class="p">:</span>
                            <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">file_tag</span><span class="o">=</span><span class="n">file_tag</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="p">(</span><span class="n">dataclass</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">file_tag</span><span class="o">=</span><span class="n">file_tag</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="n">ignore</span><span class="p">)</span>
                    <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">),</span>
                                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step03</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  +Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">))</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="n">Analysis</span><span class="o">.</span><span class="n">get_timetrace</span><span class="p">(</span><span class="n">methods</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Abspath</span><span class="p">),</span> <span class="n">tempobj</span><span class="p">,</span> <span class="n">afni</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                        <span class="n">df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step01</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.xlsx&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">])))</span>
                        <span class="n">df</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step02</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.xlsx&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">])))</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">arctanh</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">corr</span><span class="p">())</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step03</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.xlsx&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">finfo</span><span class="o">.</span><span class="n">Filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">])))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;timecourse&#39;</span><span class="p">:</span> <span class="n">step01</span><span class="p">,</span> <span class="s1">&#39;cc_matrix&#39;</span><span class="p">:</span> <span class="n">step02</span><span class="p">}</span></div>

<div class="viewcode-block" id="Preprocess.final_step"><a class="viewcode-back" href="../../../pynit.core.html#pynit.core.handlers.Preprocess.final_step">[docs]</a>    <span class="k">def</span> <span class="nf">final_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">ds_type</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">processing</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>
        <span class="n">methods</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">ds_type</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">processing</span><span class="p">),</span> <span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prjobj</span><span class="o">.</span><span class="n">scan_prj</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">path</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, SungHo Lee.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'dev01',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>